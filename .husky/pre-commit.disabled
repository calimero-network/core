#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸ”§ Running pre-commit hooks..."

# Check for changes in Rust files
if git diff --cached --name-only | grep -qE '\.rs$'; then
  echo "ğŸ“¦ Rust files detected, running formatting and checks..."
  
  # Format Rust code
  echo "ğŸ¨ Formatting Rust code..."
  cargo fmt --all -- --check || {
    echo "âŒ Rust formatting failed. Run 'cargo fmt --all' to fix."
    exit 1
  }
  
  # Run clippy for linting
  echo "ğŸ” Running clippy checks..."
  cargo clippy --all-targets --all-features -- -D warnings || {
    echo "âŒ Clippy found issues. Fix them before committing."
    exit 1
  }
  
  # Check for common issues
  echo "âœ… Rust checks passed!"
fi

# Check for changes in TOML files (Cargo.toml, etc.)
if git diff --cached --name-only | grep -qE '\.toml$'; then
  echo "ğŸ“‹ TOML files detected, checking syntax..."
  # Validate TOML syntax
  for file in $(git diff --cached --name-only | grep '\.toml$'); do
    if ! cargo verify-project --manifest-path "$file" 2>/dev/null; then
      echo "âŒ TOML syntax error in $file"
      exit 1
    fi
  done
  echo "âœ… TOML files are valid!"
fi

# Check for changes in YAML files (workflows)
if git diff --cached --name-only | grep -qE '\.ya?ml$'; then
  echo "ğŸ“„ YAML files detected, checking syntax..."
  for file in $(git diff --cached --name-only | grep '\.ya?ml$'); do
    if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
      echo "âŒ YAML syntax error in $file"
      exit 1
    fi
  done
  echo "âœ… YAML files are valid!"
fi

echo "ğŸ‰ All pre-commit checks passed!"
