name: E2E Tests - Merobox (Clean Matrix Version)

permissions:
  contents: read

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'crates/**'
      - 'apps/**'
      - 'e2e-tests-merobox/**'
      - '.github/workflows/e2e-tests-merobox.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CALIMERO_CONTRACTS_VERSION: "latest"

jobs:
  build:
    name: Build Binaries & Apps
    runs-on: ubuntu-24.04-8cpu
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-build-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build merod binary
        run: cargo build --bin merod

      - name: Build all apps
        run: ./scripts/build-all-apps.sh

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/debug/merod
            target/app-release
            apps/*/res/*.wasm
          key: ${{ steps.cache-key.outputs.key }}

  test:
    name: E2E Tests
    needs: build
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/debug/merod
            target/app-release
            apps/*/res/*.wasm
          key: ${{ needs.build.outputs.cache-key }}

      - name: Clone merobox
        run: |
          git clone https://github.com/calimero-network/merobox.git

      - name: Install merobox
        run: |
          pip install -e ./merobox

      - name: Verify merobox installation
        run: |
          merobox --version

      - name: Download Contracts
        run: |
          echo "Downloading contracts, target version: $CALIMERO_CONTRACTS_VERSION"
          ./scripts/download-contracts.sh

      - name: Install DFX for ICP
        uses: dfinity/setup-dfx@main

      - name: Install Foundry for Ethereum
        uses: foundry-rs/foundry-toolchain@v1

      - name: Deploy ICP Devnet
        run: |
          ./scripts/icp/deploy-devnet.sh

      - name: Deploy Ethereum Devnet
        run: |
          ./scripts/ethereum/deploy-devnet.sh

      - name: Setup Test Functions
        run: |
          # Create reusable function for running merobox tests
          cat > /tmp/run_merobox_test.sh <<'EOF'
          #!/bin/bash
          
          # Function to run merobox test and generate summary.json
          # Usage: run_merobox_test <workflow_file> <result_protocol_name> <test_description>
          run_merobox_test() {
            local workflow_file="$1"
            local result_protocol="$2" 
            local test_description="$3"
            
          echo "=========================================="
            echo "Running $test_description"
          echo "=========================================="

            # Create output directory and log file
            mkdir -p "e2e-tests-merobox/results/$result_protocol"
            local log_file="e2e-tests-merobox/results/$result_protocol/test.log"
            local start_time=$(date +%s)
            
            # Capture exit code and run merobox with logging
            set +e
            set -o pipefail
          merobox bootstrap run \
              "$workflow_file" \
            --no-docker \
            --binary-path target/debug/merod \
            --e2e-mode \
              --verbose 2>&1 | tee "$log_file"
            local exit_code=${PIPESTATUS[0]}
            set +o pipefail
            set -e
            
            local end_time=$(date +%s)
            local duration=$((end_time - start_time))
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            # Extract step counts from log (matching local script logic)
            local total_steps
            total_steps=$(grep -c "Step " "$log_file" 2>/dev/null || true)
            total_steps=${total_steps:-0}
            
            local passed_steps
            passed_steps=$(grep -c "âœ“\|âœ…\|succeeded\|completed" "$log_file" 2>/dev/null || true)
            passed_steps=${passed_steps:-0}
            
            local failed_steps
            failed_steps=$(grep -c "âœ—\|âŒ\|failed\|error" "$log_file" 2>/dev/null || true)
            failed_steps=${failed_steps:-0}
            
            # Check for failure indicators in the log
            local has_failure=false
            if grep -q "Workflow failed\|Step.*failed\|ERROR\|Error:" "$log_file" 2>/dev/null; then
              has_failure=true
            fi
            
            # Generate complete summary.json matching local script format
            if [ "$exit_code" -eq 0 ] && [ "$has_failure" = false ]; then
              cat > "e2e-tests-merobox/results/$result_protocol/summary.json" <<SUMMARY_EOF
          {
            "status": "passed",
            "protocol": "$result_protocol",
            "duration": $duration,
            "total_steps": $total_steps,
            "passed_steps": $passed_steps,
            "failed_steps": $failed_steps,
            "workflow": "$workflow_file",
            "timestamp": "$timestamp"
          }
          SUMMARY_EOF
            else
              cat > "e2e-tests-merobox/results/$result_protocol/summary.json" <<SUMMARY_EOF
          {
            "status": "failed",
            "protocol": "$result_protocol",
            "duration": $duration,
            "total_steps": $total_steps,
            "passed_steps": $passed_steps,
            "failed_steps": $failed_steps,
            "workflow": "$workflow_file",
            "timestamp": "$timestamp",
            "exit_code": $exit_code
          }
          SUMMARY_EOF
            fi
            
            # Return the original exit code
            return $exit_code
          }
          EOF
          
          chmod +x /tmp/run_merobox_test.sh
          source /tmp/run_merobox_test.sh

      - name: Run All Merobox Tests
        env:
          NO_COLOR: 1
          RUST_LOG: calimero_=debug
          CALIMERO_TRANSPORT_NEAR_UNIQUE_CONNECTIONS: 1
        run: |
          source /tmp/run_merobox_test.sh
          
          # Run all protocols sequentially to avoid port conflicts
          all_failed_tests=()
          all_passed_tests=()
          
          for protocol in near icp ethereum; do
            echo ""
            echo "ðŸš€ Starting tests for protocol: $protocol"
            echo "=================================================="
            echo ""
            
            # Define test configurations for current protocol
            declare -A tests
            
            # Tests that run on all protocols
            if [ "$protocol" = "near" ]; then
              tests["kv-store"]="apps/kv-store/workflows/bundle-invitation-test.yml|$protocol"
            else
              tests["kv-store"]="apps/kv-store/workflows/$protocol.yml|$protocol"
            fi
            tests["proposals"]="workflows/proposals/$protocol-proposals.yml|$protocol-proposals"
            
            # NEAR-only tests
            if [ "$protocol" = "near" ]; then
              tests["kv-store-init"]="apps/kv-store-init/workflows/workflow-init.yml|near-init"
              tests["kv-store-handlers"]="apps/kv-store-with-handlers/workflows/workflow.yml|near-handlers"
              tests["blobs"]="apps/blobs/workflows/blobs-example.yml|near-blobs"
              tests["collaborative-editor"]="apps/collaborative-editor/workflows/collaborative-editor.yml|near-collab"
              tests["nested-crdt"]="apps/nested-crdt-test/workflows/workflow.yml|near-nested"
              tests["team-metrics"]="workflows/team-metrics/workflow.yml|near-metrics"
              tests["concurrent-mutations"]="workflows/concurrent-mutations/workflow.yml|near-concurrent"
              tests["open-invitation"]="workflows/open-invitation/workflow.yml|near-open-invitation"
              tests["private-data"]="apps/private_data/workflows/example.yml|near-private-data"
              tests["xcall-example"]="apps/xcall-example/workflows/xcall-example.yml|near-xcall"
              tests["access-control"]="apps/access-control/workflows/test_access_control.yml|near-access-control"
              tests["user-storage"]="apps/kv-store-with-user-and-frozen-storage/workflows/test_user_storage.yml|near-user-storage"
              tests["frozen-storage"]="apps/kv-store-with-user-and-frozen-storage/workflows/test_frozen_storage.yml|near-frozen-storage"
            fi
            
            # Run all tests for this protocol
            protocol_failed_tests=()
            protocol_passed_tests=()
            
            for test_name in "${!tests[@]}"; do
              IFS='|' read -r workflow_file result_protocol <<< "${tests[$test_name]}"
              
              echo ""
              echo "ðŸ§ª Running test: $test_name"
              echo "ðŸ“ Workflow: $workflow_file"
              echo "ðŸ“Š Results: $result_protocol"
              echo "ðŸ”— Protocol: $protocol"
              echo ""
              
              if run_merobox_test "$workflow_file" "$result_protocol" "$test_name tests for $protocol"; then
                protocol_passed_tests+=("$test_name")
                all_passed_tests+=("$test_name")
                echo "âœ… Test $test_name passed"
              else
                protocol_failed_tests+=("$test_name")
                all_failed_tests+=("$test_name")
                echo "âŒ Test $test_name failed"
              fi
            done
            
            # Report results for this protocol
            echo ""
            echo "ðŸ“Š Results for $protocol:"
            echo "âœ… Passed: ${#protocol_passed_tests[@]} tests"
            if [ ${#protocol_passed_tests[@]} -gt 0 ]; then
              printf "  âœ… %s\n" "${protocol_passed_tests[@]}"
            fi
            echo "âŒ Failed: ${#protocol_failed_tests[@]} tests"
            if [ ${#protocol_failed_tests[@]} -gt 0 ]; then
              printf "  âŒ %s\n" "${protocol_failed_tests[@]}"
            fi
            echo ""
            
            # Clear tests array for next protocol
            unset tests
          done
          
          # Use the aggregated results for final reporting
          failed_tests=("${all_failed_tests[@]}")
          passed_tests=("${all_passed_tests[@]}")
          
          # Report results
          echo ""
          echo "=========================================="
          echo "Test Summary for All Protocols"
          echo "=========================================="
          failed_count=${#failed_tests[@]}
          passed_count=${#passed_tests[@]}
          total_count=$((failed_count + passed_count))
          
          echo "Total tests: $total_count"
          echo "Passed: $passed_count"
          echo "Failed: $failed_count"
          
          if [ $passed_count -gt 0 ]; then
            echo ""
            echo "Passed tests:"
            for test in "${passed_tests[@]}"; do
              echo "  âœ… $test"
            done
          fi
          
          if [ $failed_count -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            for test in "${failed_tests[@]}"; do
              echo "  âŒ $test"
            done
            echo ""
            echo "âŒ Some tests failed across all protocols"
            exit 1
          else
            echo ""
            echo "âœ… All tests passed across all protocols"
          fi

      - name: Upload Test Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results-all-protocols
          path: e2e-tests-merobox/results/
          retention-days: 2

      - name: Upload Node Logs and Data for Debugging
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-data-all-protocols
          path: |
            data/
            ~/.merobox/logs/
          retention-days: 7

  report:
    name: Generate Test Report
    needs: test
    runs-on: ubuntu-24.04-8cpu
    permissions:
      contents: read
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: results/
          merge-multiple: true

      - name: Generate Test Report
        run: |
          echo "# E2E Test Results" > test-report.md
          echo "" >> test-report.md
          echo "| Protocol | Test Suite | Status | Workflow |" >> test-report.md
          echo "|----------|------------|--------|----------|" >> test-report.md
          
          # Process all summary.json files
          find results/ -name "summary.json" | sort | while read -r file; do
            if [ -f "$file" ]; then
              status=$(jq -r '.status' "$file" 2>/dev/null || echo "unknown")
              protocol=$(jq -r '.protocol' "$file" 2>/dev/null || echo "unknown")
              workflow=$(jq -r '.workflow' "$file" 2>/dev/null || echo "unknown")
              
              # Extract test suite name from workflow path
              test_suite=$(basename "$workflow" .yml)
              
              # Status emoji
              if [ "$status" = "passed" ]; then
                status_icon="âœ…"
              else
                status_icon="âŒ"
              fi
              
              echo "| $protocol | $test_suite | $status_icon $status | \`$workflow\` |" >> test-report.md
            fi
          done
          
          echo "" >> test-report.md
          echo "Generated at: $(date -u)" >> test-report.md
          
          # Show the report
          echo "=========================================="
          echo "TEST REPORT"
          echo "=========================================="
          cat test-report.md

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
          retention-days: 7
