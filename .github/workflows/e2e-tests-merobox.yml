name: E2E Tests - Merobox (Clean Matrix Version)

permissions:
  contents: read

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'crates/**'
      - 'apps/**'
      - 'e2e-tests-merobox/**'
      - '.github/workflows/e2e-tests-merobox.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CALIMERO_CONTRACTS_VERSION: "latest"

jobs:
  build:
    name: Build Binaries & Apps
    runs-on: ubuntu-24.04-8cpu
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-build-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Build merod binary
        run: cargo build --bin merod

      - name: Build all apps
        run: ./scripts/build-all-apps.sh

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/debug/merod
            target/app-release
          key: ${{ steps.cache-key.outputs.key }}

  test:
    name: E2E Tests
    needs: build
    runs-on: ubuntu-24.04-8cpu
    strategy:
      fail-fast: false
      matrix:
        protocol: [near, icp, ethereum]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            target/debug/merod
            target/app-release
          key: ${{ needs.build.outputs.cache-key }}

      - name: Clone merobox
        run: |
          git clone https://github.com/calimero-network/merobox.git

      - name: Install merobox
        run: |
          pip install -e ./merobox

      - name: Verify merobox installation
        run: |
          merobox --version

      - name: Download Contracts
        run: |
          echo "Downloading contracts, target version: $CALIMERO_CONTRACTS_VERSION"
          ./scripts/download-contracts.sh

      - name: Install DFX for ICP
        if: matrix.protocol == 'icp'
        uses: dfinity/setup-dfx@main

      - name: Install Foundry for Ethereum
        if: matrix.protocol == 'ethereum'
        uses: foundry-rs/foundry-toolchain@v1

      - name: Deploy ICP Devnet
        if: matrix.protocol == 'icp'
        run: |
          ./scripts/icp/deploy-devnet.sh

      - name: Deploy Ethereum Devnet
        if: matrix.protocol == 'ethereum'
        run: |
          ./scripts/ethereum/deploy-devnet.sh

      - name: Setup Test Functions
        run: |
          # Create reusable function for running merobox tests
          cat > /tmp/run_merobox_test.sh <<'EOF'
          #!/bin/bash
          
          # Function to run merobox test and generate summary.json
          # Usage: run_merobox_test <workflow_file> <result_protocol_name> <test_description>
          run_merobox_test() {
            local workflow_file="$1"
            local result_protocol="$2" 
            local test_description="$3"
            
          echo "=========================================="
            echo "Running $test_description"
          echo "=========================================="

            # Capture exit code and run merobox
            set +e
          merobox bootstrap run \
              "$workflow_file" \
            --no-docker \
            --binary-path target/debug/merod \
            --verbose
            local exit_code=$?
            set -e
            
            # Generate summary.json for CI report
            mkdir -p "e2e-tests-merobox/results/$result_protocol"
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            
            if [ $exit_code -eq 0 ]; then
              cat > "e2e-tests-merobox/results/$result_protocol/summary.json" <<SUMMARY_EOF
          {
            "status": "passed",
            "protocol": "$result_protocol",
            "workflow": "$workflow_file",
            "timestamp": "$timestamp",
            "exit_code": $exit_code
          }
          SUMMARY_EOF
            else
              cat > "e2e-tests-merobox/results/$result_protocol/summary.json" <<SUMMARY_EOF
          {
            "status": "failed",
            "protocol": "$result_protocol",
            "workflow": "$workflow_file",
            "timestamp": "$timestamp",
            "exit_code": $exit_code
          }
          SUMMARY_EOF
            fi
            
            # Return the original exit code
            return $exit_code
          }
          EOF
          
          chmod +x /tmp/run_merobox_test.sh
          source /tmp/run_merobox_test.sh

      - name: Run All Merobox Tests
        env:
          NO_COLOR: 1
          RUST_LOG: calimero_=debug
          CALIMERO_TRANSPORT_NEAR_UNIQUE_CONNECTIONS: 1
        run: |
          source /tmp/run_merobox_test.sh
          
          # Define test configurations
          declare -A tests
          
          # Tests that run on all protocols
          if [ "${{ matrix.protocol }}" = "near" ]; then
            tests["kv-store"]="e2e-tests-merobox/workflows/kv-store/workflow-near.yml|${{ matrix.protocol }}"
          else
            tests["kv-store"]="e2e-tests-merobox/workflows/kv-store/${{ matrix.protocol }}.yml|${{ matrix.protocol }}"
          fi
          tests["proposals"]="e2e-tests-merobox/workflows/proposals/${{ matrix.protocol }}-proposals.yml|${{ matrix.protocol }}-proposals"
          
          # NEAR-only tests
          if [ "${{ matrix.protocol }}" = "near" ]; then
            tests["kv-store-init"]="e2e-tests-merobox/workflows/kv-store/workflow-init.yml|near-init"
            tests["kv-store-handlers"]="e2e-tests-merobox/workflows/kv-store-with-handlers/workflow.yml|near-handlers"
            tests["blobs"]="e2e-tests-merobox/workflows/blobs/workflow.yml|near-blobs"
            tests["collaborative-editor"]="e2e-tests-merobox/workflows/collaborative-editor/workflow.yml|near-collab"
            tests["nested-crdt"]="e2e-tests-merobox/workflows/nested-crdt/workflow.yml|near-nested"
            tests["team-metrics"]="e2e-tests-merobox/workflows/team-metrics/workflow.yml|near-metrics"
            tests["concurrent-mutations"]="e2e-tests-merobox/workflows/concurrent-mutations/workflow.yml|near-concurrent"
            tests["open-invitation"]="e2e-tests-merobox/workflows/open-invitation/workflow.yml|near-open-invitation"
            tests["private-data"]="e2e-tests-merobox/workflows/private-data/workflow.yml|near-private-data"
            tests["xcall-example"]="e2e-tests-merobox/workflows/xcall-example/workflow.yml|near-xcall"
          fi
          
          # Run all tests for this protocol
          failed_tests=()
          passed_tests=()
          
          for test_name in "${!tests[@]}"; do
            IFS='|' read -r workflow_file result_protocol <<< "${tests[$test_name]}"
            
            echo ""
            echo "ðŸ§ª Running test: $test_name"
            echo "ðŸ“ Workflow: $workflow_file"
            echo "ðŸ“Š Results: $result_protocol"
            echo "ðŸ”— Protocol: ${{ matrix.protocol }}"
            echo ""
            
            if run_merobox_test "$workflow_file" "$result_protocol" "$test_name tests for ${{ matrix.protocol }}"; then
              passed_tests+=("$test_name")
              echo "âœ… Test $test_name passed"
            else
              failed_tests+=("$test_name")
              echo "âŒ Test $test_name failed"
            fi
          done
          
          # Report results
          echo ""
          echo "=========================================="
          echo "Test Summary for ${{ matrix.protocol }}"
          echo "=========================================="
          total_tests=${#tests[@]}
          failed_count=${#failed_tests[@]}
          passed_count=${#passed_tests[@]}
          
          echo "Total tests: $total_tests"
          echo "Passed: $passed_count"
          echo "Failed: $failed_count"
          
          if [ $passed_count -gt 0 ]; then
            echo ""
            echo "Passed tests:"
            for test in "${passed_tests[@]}"; do
              echo "  âœ… $test"
            done
          fi
          
          if [ $failed_count -gt 0 ]; then
            echo ""
            echo "Failed tests:"
            for test in "${failed_tests[@]}"; do
              echo "  âŒ $test"
            done
            echo ""
            echo "âŒ Some tests failed for ${{ matrix.protocol }}"
            exit 1
          else
            echo ""
            echo "âœ… All tests passed for ${{ matrix.protocol }}"
          fi

      - name: Upload Test Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.protocol }}
          path: e2e-tests-merobox/results/
          retention-days: 2

  report:
    name: Generate Test Report
    needs: test
    runs-on: ubuntu-24.04-8cpu
    permissions:
      contents: read
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: results/
          merge-multiple: true

      - name: Generate Test Report
        run: |
          echo "# E2E Test Results" > test-report.md
          echo "" >> test-report.md
          echo "| Protocol | Test Suite | Status | Workflow |" >> test-report.md
          echo "|----------|------------|--------|----------|" >> test-report.md
          
          # Process all summary.json files
          find results/ -name "summary.json" | sort | while read -r file; do
            if [ -f "$file" ]; then
              status=$(jq -r '.status' "$file" 2>/dev/null || echo "unknown")
              protocol=$(jq -r '.protocol' "$file" 2>/dev/null || echo "unknown")
              workflow=$(jq -r '.workflow' "$file" 2>/dev/null || echo "unknown")
              
              # Extract test suite name from workflow path
              test_suite=$(basename "$workflow" .yml)
              
              # Status emoji
              if [ "$status" = "passed" ]; then
                status_icon="âœ…"
              else
                status_icon="âŒ"
              fi
              
              echo "| $protocol | $test_suite | $status_icon $status | \`$workflow\` |" >> test-report.md
            fi
          done
          
          echo "" >> test-report.md
          echo "Generated at: $(date -u)" >> test-report.md
          
          # Show the report
          echo "=========================================="
          echo "TEST REPORT"
          echo "=========================================="
          cat test-report.md

      - name: Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          path: test-report.md
          retention-days: 7
