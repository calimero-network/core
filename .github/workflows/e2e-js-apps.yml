name: E2E - JS Apps

# Tests JavaScript SDK examples using locally-built Docker image.
# Fast PR testing - builds merod locally instead of waiting for release.

permissions:
  contents: read

on:
  pull_request:
    branches: [master]
    paths:
      - "crates/**"
      - ".github/workflows/e2e-js-apps.yml"
  push:
    branches: [master]
    paths:
      - "crates/**"
      - ".github/workflows/e2e-js-apps.yml"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  NODE_VERSION: "18.x"
  PNPM_VERSION: "9"
  CALIMERO_CONTRACTS_VERSION: "latest"
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

jobs:
  build-merod:
    name: Build Merod Image
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Setup Rust CI
        uses: ./.github/actions/setup-rust-ci
        with:
          toolchain: stable
          shared-key: e2e-js-apps
          save-if: ${{ github.ref == 'refs/heads/master' }}

      - name: Build local merod image
        uses: ./.github/actions/build-local-merod
        env:
          CALIMERO_WEBUI_FETCH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CALIMERO_AUTH_FRONTEND_FETCH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Export Docker image
        run: |
          docker save merod:local -o merod-local.tar
          gzip merod-local.tar

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-js-apps-merod-image
          path: merod-local.tar.gz
          retention-days: 1

  download-contracts:
    name: Download Contracts
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Contracts
        uses: ./.github/actions/download-contracts

      - name: Upload contracts artifact
        uses: actions/upload-artifact@v4
        with:
          name: e2e-js-apps-contracts
          path: contracts
          retention-days: 1

  test-sdk-js:
    name: Test SDK JS
    needs: [build-merod, download-contracts]
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout Core code
        uses: actions/checkout@v4

      - name: Download contracts artifact
        uses: actions/download-artifact@v4
        with:
          name: e2e-js-apps-contracts
          path: contracts

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: e2e-js-apps-merod-image

      - name: Load Docker image
        run: |
          gunzip merod-local.tar.gz
          docker load -i merod-local.tar
          docker images merod:local

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup merobox
        uses: ./.github/actions/setup-merobox-pypi

      - name: Clone SDK JS repository
        run: |
          git clone https://github.com/calimero-network/calimero-sdk-js.git sdk-js
          cd sdk-js
          git checkout master || git checkout main

      - name: Install SDK JS dependencies
        working-directory: sdk-js
        run: |
          pnpm install --frozen-lockfile

      - name: Build SDK JS packages
        working-directory: sdk-js
        run: |
          pnpm build

      - name: Install CLI build dependencies
        working-directory: sdk-js/packages/cli
        run: |
          pnpm install-deps

      - name: Build SDK JS examples
        working-directory: sdk-js
        run: |
          set -e
          for dir in examples/*/; do
              cd "$dir" && pnpm build:manual && cd ../..
          done

      - name: Verify WASM outputs
        working-directory: sdk-js
        run: |
          set -e
          for dir in examples/*/; do
              if ! ls "${dir}build/"*.wasm 1> /dev/null 2>&1; then
                  echo "Error: No WASM file found in ${dir}build/"
                  exit 1
              fi
          done

      - name: Run SDK JS Merobox Workflows
        id: run_workflows
        run: |
          mkdir -p docker-logs
          cd sdk-js

          merobox stop --all || true
          merobox nuke -f || true

          WORKFLOW_FILES=()
          while IFS= read -r -d '' file; do
              WORKFLOW_FILES+=("$file")
          done < <(find examples -type f -name "*.yml" -path "*/workflows/*" -print0 2>/dev/null)
          while IFS= read -r -d '' file; do
              WORKFLOW_FILES+=("$file")
          done < <(find examples -type f -name "default.yml" ! -path "*/workflows/*" -print0 2>/dev/null)

          if [ ${#WORKFLOW_FILES[@]} -eq 0 ]; then
              echo "Error: No workflow files found in examples directories"
              exit 1
          fi

          FAILED_WORKFLOWS=()

          for workflow in "${WORKFLOW_FILES[@]}"; do
              if merobox bootstrap run "$workflow" \
                  --image merod:local \
                  --e2e-mode \
                  --near-devnet \
                  --contracts-dir "$GITHUB_WORKSPACE/contracts/near" \
                  --verbose; then
                  :
              else
                  FAILED_WORKFLOWS+=("$workflow")
              fi
              
              # Collect logs
              workflow_id=$(echo "$workflow" | sed 's|/|-|g' | sed 's|\.yml$||')
              for container in $(docker ps -a --filter "label=calimero.node=true" --format "{{.Names}}" 2>/dev/null || true); do
                  if [ -n "$container" ]; then
                      docker logs "$container" > "$GITHUB_WORKSPACE/docker-logs/${workflow_id}-${container}.log" 2>&1 || true
                  fi
              done
              
              merobox stop --all || true
              merobox nuke -f || true
          done

          if [ ${#FAILED_WORKFLOWS[@]} -gt 0 ]; then
              echo "has_failures=true" >> $GITHUB_OUTPUT
              printf '%s\n' "${FAILED_WORKFLOWS[@]}" > failed_workflows.txt
          else
              echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Failed Workflows
        if: steps.run_workflows.outputs.has_failures == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-js-apps-failed-workflows
          path: sdk-js/failed_workflows.txt
          retention-days: 1

      - name: Upload Workflow Data Artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: e2e-js-apps-data-${{ github.sha }}
          path: |
            sdk-js/examples/*/build/*.wasm
            sdk-js/examples/*/res/*.wasm
            sdk-js/examples/*/res/*.mpk
            sdk-js/examples/*/res/abi.json
            sdk-js/examples/*/res/state-schema.json
            sdk-js/examples/*/data/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Docker Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-js-apps-docker-logs-${{ github.sha }}
          path: docker-logs/
          retention-days: 7
          if-no-files-found: warn

      - name: Fail if workflows failed
        if: steps.run_workflows.outputs.has_failures == 'true'
        run: exit 1

  comment:
    name: Report Failed Workflows
    needs: test-sdk-js
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check if main job failed or was cancelled
        id: check_status
        run: |
          if [ "${{ needs.test-sdk-js.result }}" != "success" ]; then
            echo "job_failed=true" >> $GITHUB_OUTPUT
            if [ "${{ needs.test-sdk-js.result }}" == "cancelled" ]; then
              echo "was_cancelled=true" >> $GITHUB_OUTPUT
            else
              echo "was_cancelled=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "job_failed=false" >> $GITHUB_OUTPUT
          fi

      - name: Download Failed Workflows
        id: download
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: e2e-js-apps-failed-workflows

      - name: Prepare Failure Comment
        if: steps.download.outcome == 'success'
        run: |
          failed_list=$(cat failed_workflows.txt | sed 's/^/- /')
          message="## E2E JS Apps Failed

          The following SDK JS workflow(s) failed:
          $failed_list

          Please check the workflow logs for more details."

          jq -n \
            --arg pr '${{ github.event.number }}' \
            --arg tag e2e-js-apps-report \
            --arg mode recreate \
            --arg message "$message" \
            '{pr: $pr, tag: $tag, mode: $mode, message: $message}' > payload.json

      - name: Upload Comment
        if: steps.download.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: pr-comment-payload-js-apps
          path: payload.json

      - name: Fail if main job failed or was cancelled
        if: steps.check_status.outputs.job_failed == 'true'
        run: |
          if [ "${{ steps.check_status.outputs.was_cancelled }}" == "true" ]; then
            echo "Workflow was cancelled"
          else
            echo "Workflow failed"
          fi
          exit 1
