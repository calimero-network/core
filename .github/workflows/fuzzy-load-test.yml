name: Fuzzy Load Test - Long Running Performance with Profiling

permissions:
  contents: read

on:
  push:
    branches: [master]
    paths:
      - "crates/**"
      - "apps/**"
      - "workflows/fuzzy-tests/**"
      - ".github/workflows/fuzzy-load-test.yml"
  pull_request:
    paths:
      - "crates/**"
      - "apps/**"
      - "workflows/fuzzy-tests/**"
      - ".github/workflows/fuzzy-load-test.yml"

  workflow_dispatch:
    inputs:
      duration_override:
        description: "Override test duration (minutes per app)"
        required: false
        default: "45"
        type: string
      test_app:
        description: "Run specific app test (kv-store, kv-store-with-handlers, or all)"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - kv-store
          - kv-store-with-handlers
      enable_profiling:
        description: "Use profiling image (merod:edge-profiling) with CPU and memory profiling enabled"
        required: false
        default: true
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false # Don't cancel long-running tests

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  RUST_LOG: info,calimero_=debug

jobs:
  build:
    name: Build Apps
    runs-on: ubuntu-24.04-8cpu
    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-fuzzy-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Download NEAR contracts
        run: |
          ./scripts/download-contracts.sh

      - name: Build kv-store app
        run: |
          cd apps/kv-store
          ./build.sh
        env:
          WASM_PROFILING: "true"

      - name: Build kv-store-with-handlers app
        run: |
          cd apps/kv-store-with-handlers
          ./build.sh
        env:
          WASM_PROFILING: "true"

      - name: Verify WASM files exist
        run: |
          ls -la apps/kv-store/res/
          ls -la apps/kv-store-with-handlers/res/
          test -f apps/kv-store/res/kv_store.wasm
          test -f apps/kv-store-with-handlers/res/kv_store_with_handlers.wasm

      - name: Cache build artifacts
        uses: actions/cache@v4
        with:
          path: |
            apps/kv-store/res/*.wasm
            apps/kv-store-with-handlers/res/*.wasm
            contracts/near
          key: ${{ steps.cache-key.outputs.key }}

  fuzzy-test-kv-store:
    name: Run KV Store Fuzzy Test with Profiling
    needs: build
    runs-on: ubuntu-24.04-8cpu
    timeout-minutes: 150
    outputs:
      test_passed: ${{ steps.set-result.outputs.passed }}
      exit_code: ${{ steps.kv-test.outputs.exit_code }}
    if: github.event.inputs.test_app == 'all' || github.event.inputs.test_app == 'kv-store' || github.event.inputs.test_app == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            apps/kv-store/res/*.wasm
            apps/kv-store-with-handlers/res/*.wasm
            contracts/near
          key: ${{ needs.build.outputs.cache-key }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clone merobox
        run: |
          git clone https://github.com/calimero-network/merobox.git

      - name: Install merobox
        run: |
          pip install -e ./merobox

      - name: Override test duration
        run: |
          # TODO: REVERT BEFORE PR MERGE - Change default back to '45' after testing is complete
          # This 5-minute duration is only for testing purposes
          DURATION="${{ github.event.inputs.duration_override || '5' }}"
          cd workflows/fuzzy-tests/kv-store
          sed -i "s/\(duration_minutes: \)[0-9]*/\1$DURATION/" fuzzy-test.yml
          echo "Updated test duration to $DURATION minutes"
          grep "duration_minutes:" fuzzy-test.yml

      - name: Create directories
        run: |
          mkdir -p fuzzy-test-logs/kv-store
          mkdir -p profiling-data/kv-store
          mkdir -p profiling-reports/kv-store

      - name: Determine image to use
        id: image
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event.inputs.enable_profiling }}" = "false" ]; then
            # Standard image without profiling
            chmod +x scripts/determine-image-tag.sh
            ./scripts/determine-image-tag.sh \
              "${{ github.event_name }}" \
              "${{ github.event.pull_request.number || '0' }}" \
              "${{ github.repository_owner }}" \
              "${{ github.repository }}" \
              "${{ github.head_ref || github.ref_name }}" \
              "${{ github.token }}"
            echo "profiling=false" >> $GITHUB_OUTPUT
          else
            # Profiling image - wait for release workflow to complete
            chmod +x scripts/determine-image-tag.sh
            ./scripts/determine-image-tag.sh \
              "${{ github.event_name }}" \
              "${{ github.event.pull_request.number || '0' }}" \
              "${{ github.repository_owner }}" \
              "${{ github.repository }}" \
              "${{ github.head_ref || github.ref_name }}" \
              "${{ github.token }}" \
              --profiling
            echo "profiling=true" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        run: |
          IMAGE="ghcr.io/calimero-network/merod:${{ steps.image.outputs.tag }}"
          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE" || echo "Warning: Could not pre-pull image. Merobox will attempt to pull it."

      - name: Run KV Store Fuzzy Test
        id: kv-test
        continue-on-error: true
        run: |
          cd workflows/fuzzy-tests/kv-store

          echo "start_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

          # Note: The profiling image (merod:edge-profiling) has profiling enabled by default.
          # The standard image (merod:edge) runs without profiling.

          IMAGE="ghcr.io/calimero-network/merod:${{ steps.image.outputs.tag }}"
          echo "Using image: $IMAGE"

          set +e
          set -o pipefail 
          merobox bootstrap run \
              fuzzy-test.yml \
              --image "$IMAGE" \
              --e2e-mode \
              --near-devnet \
              --contracts-dir "$GITHUB_WORKSPACE/contracts/near" \
              --verbose 2>&1 | tee ../../../fuzzy-test-logs/kv-store/merobox-output.log

          exit_code=$?
          set +o pipefail  

          echo "end_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Collect profiling data from containers
        if: always() && steps.image.outputs.profiling == 'true'
        run: |
          chmod +x scripts/profiling/collect-from-containers.sh
          ./scripts/profiling/collect-from-containers.sh \
            "kv-store" \
            "fuzzy-test-logs/kv-store" \
            "profiling-data/kv-store" \
            "profiling-reports/kv-store"

      - name: Set test result
        id: set-result
        if: always()
        run: |
          EXIT_CODE="${{ steps.kv-test.outputs.exit_code }}"
          if [ "$EXIT_CODE" = "0" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Collect KV Store node logs
        if: always()
        run: |
          find workflows/fuzzy-tests/kv-store -type d -name "logs" 2>/dev/null | while read logdir; do
            relpath=$(echo "$logdir" | sed 's|workflows/fuzzy-tests/kv-store/||')
            mkdir -p "fuzzy-test-logs/kv-store/$relpath"
            cp -r "$logdir"/* "fuzzy-test-logs/kv-store/$relpath/" 2>/dev/null || true
          done

      - name: Generate profiling summary
        if: always() && steps.image.outputs.profiling == 'true'
        run: |
          chmod +x scripts/profiling/generate-summary.sh
          ./scripts/profiling/generate-summary.sh \
            "KV Store" \
            "profiling-data/kv-store" \
            "profiling-reports/kv-store"

      - name: Upload KV Store test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzzy-test-kv-store-${{ github.run_number }}-${{ github.run_id }}
          path: fuzzy-test-logs/kv-store/
          retention-days: 30
          compression-level: 6

      - name: Upload KV Store profiling data
        if: always() && steps.image.outputs.profiling == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: profiling-data-kv-store-${{ github.run_number }}-${{ github.run_id }}
          path: profiling-data/kv-store/
          retention-days: 30
          compression-level: 6

      - name: Upload KV Store profiling reports
        if: always() && steps.image.outputs.profiling == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: profiling-reports-kv-store-${{ github.run_number }}-${{ github.run_id }}
          path: profiling-reports/kv-store/
          retention-days: 30
          compression-level: 6

  fuzzy-test-handlers:
    name: Run KV Store with Handlers Fuzzy Test with Profiling
    needs: build
    runs-on: ubuntu-24.04-8cpu
    timeout-minutes: 150 # Extended for profiling overhead
    outputs:
      test_passed: ${{ steps.set-result-handlers.outputs.passed }}
      exit_code: ${{ steps.handlers-test.outputs.exit_code }}
    if: github.event.inputs.test_app == 'all' || github.event.inputs.test_app == 'kv-store-with-handlers' || github.event.inputs.test_app == ''
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore build artifacts
        uses: actions/cache@v4
        with:
          path: |
            apps/kv-store/res/*.wasm
            apps/kv-store-with-handlers/res/*.wasm
            contracts/near
          key: ${{ needs.build.outputs.cache-key }}

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Clone merobox
        run: |
          git clone https://github.com/calimero-network/merobox.git

      - name: Install merobox
        run: |
          pip install -e ./merobox

      - name: Override test duration
        run: |
          # TODO: REVERT BEFORE PR MERGE - Change default back to '45' after testing is complete
          # This 5-minute duration is only for testing purposes
          DURATION="${{ github.event.inputs.duration_override || '5' }}"
          cd workflows/fuzzy-tests/kv-store-with-handlers
          sed -i "s/\(duration_minutes: \)[0-9]*/\1$DURATION/" fuzzy-test.yml
          echo "Updated test duration to $DURATION minutes"
          grep "duration_minutes:" fuzzy-test.yml

      - name: Create directories
        run: |
          mkdir -p fuzzy-test-logs/kv-store-with-handlers
          mkdir -p profiling-data/kv-store-with-handlers
          mkdir -p profiling-reports/kv-store-with-handlers

      - name: Determine image to use
        id: image
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ "${{ github.event.inputs.enable_profiling }}" = "false" ]; then
            # Standard image without profiling
            chmod +x scripts/determine-image-tag.sh
            ./scripts/determine-image-tag.sh \
              "${{ github.event_name }}" \
              "${{ github.event.pull_request.number || '0' }}" \
              "${{ github.repository_owner }}" \
              "${{ github.repository }}" \
              "${{ github.head_ref || github.ref_name }}" \
              "${{ github.token }}"
            echo "profiling=false" >> $GITHUB_OUTPUT
          else
            # Profiling image - wait for release workflow to complete
            chmod +x scripts/determine-image-tag.sh
            ./scripts/determine-image-tag.sh \
              "${{ github.event_name }}" \
              "${{ github.event.pull_request.number || '0' }}" \
              "${{ github.repository_owner }}" \
              "${{ github.repository }}" \
              "${{ github.head_ref || github.ref_name }}" \
              "${{ github.token }}" \
              --profiling
            echo "profiling=true" >> $GITHUB_OUTPUT
          fi

      - name: Pull Docker image
        run: |
          IMAGE="ghcr.io/calimero-network/merod:${{ steps.image.outputs.tag }}"
          echo "Pulling image: $IMAGE"
          docker pull "$IMAGE" || echo "Warning: Could not pre-pull image. Merobox will attempt to pull it."

      - name: Run Handlers Fuzzy Test
        id: handlers-test
        continue-on-error: true
        run: |
          cd workflows/fuzzy-tests/kv-store-with-handlers

          echo "start_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

          # Note: The profiling image (merod:edge-profiling) has profiling enabled by default.
          # The standard image (merod:edge) runs without profiling.

          IMAGE="ghcr.io/calimero-network/merod:${{ steps.image.outputs.tag }}"
          echo "Using image: $IMAGE"

          set +e
          set -o pipefail  
          merobox bootstrap run \
              fuzzy-test.yml \
              --image "$IMAGE" \
              --e2e-mode \
              --near-devnet \
              --contracts-dir "$GITHUB_WORKSPACE/contracts/near" \
              --verbose 2>&1 | tee ../../../fuzzy-test-logs/kv-store-with-handlers/merobox-output.log

          exit_code=$?
          set +o pipefail 

          echo "end_time=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          exit $exit_code

      - name: Collect profiling data from containers
        if: always() && steps.image.outputs.profiling == 'true'
        run: |
          chmod +x scripts/profiling/collect-from-containers.sh
          ./scripts/profiling/collect-from-containers.sh \
            "kv-store-with-handlers" \
            "fuzzy-test-logs/kv-store-with-handlers" \
            "profiling-data/kv-store-with-handlers" \
            "profiling-reports/kv-store-with-handlers"

      - name: Set test result
        id: set-result-handlers
        if: always()
        run: |
          EXIT_CODE="${{ steps.handlers-test.outputs.exit_code }}"
          if [ "$EXIT_CODE" = "0" ]; then
            echo "passed=true" >> $GITHUB_OUTPUT
          else
            echo "passed=false" >> $GITHUB_OUTPUT
          fi

      - name: Collect Handlers node logs
        if: always()
        run: |
          find workflows/fuzzy-tests/kv-store-with-handlers -type d -name "logs" 2>/dev/null | while read logdir; do
            relpath=$(echo "$logdir" | sed 's|workflows/fuzzy-tests/kv-store-with-handlers/||')
            mkdir -p "fuzzy-test-logs/kv-store-with-handlers/$relpath"
            cp -r "$logdir"/* "fuzzy-test-logs/kv-store-with-handlers/$relpath/" 2>/dev/null || true
          done

      - name: Generate profiling summary
        if: always() && steps.image.outputs.profiling == 'true'
        run: |
          chmod +x scripts/profiling/generate-summary.sh
          ./scripts/profiling/generate-summary.sh \
            "KV Store with Handlers" \
            "profiling-data/kv-store-with-handlers" \
            "profiling-reports/kv-store-with-handlers"

      - name: Upload Handlers test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: fuzzy-test-handlers-${{ github.run_number }}-${{ github.run_id }}
          path: fuzzy-test-logs/kv-store-with-handlers/
          retention-days: 30
          compression-level: 6

      - name: Upload Handlers profiling data
        if: always() && steps.image.outputs.profiling == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: profiling-data-handlers-${{ github.run_number }}-${{ github.run_id }}
          path: profiling-data/kv-store-with-handlers/
          retention-days: 30
          compression-level: 6

      - name: Upload Handlers profiling reports
        if: always() && steps.image.outputs.profiling == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: profiling-reports-handlers-${{ github.run_number }}-${{ github.run_id }}
          path: profiling-reports/kv-store-with-handlers/
          retention-days: 30
          compression-level: 6

  test-summary:
    name: Test Summary
    needs: [fuzzy-test-kv-store, fuzzy-test-handlers]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## Fuzzy Load Test Results with Profiling" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Profiling Enabled:** ${{ github.event.inputs.enable_profiling || 'true' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Sample Frequency:** 99 Hz (default)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### KV Store Test" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.fuzzy-test-kv-store.result }}" = "skipped" ]; then
            echo "â­ï¸ **SKIPPED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.fuzzy-test-kv-store.outputs.test_passed }}" = "true" ]; then
            echo "âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** (exit code: ${{ needs.fuzzy-test-kv-store.outputs.exit_code }})" >> $GITHUB_STEP_SUMMARY
            echo "Check artifacts for detailed logs and analysis." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### KV Store with Handlers Test" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.fuzzy-test-handlers.result }}" = "skipped" ]; then
            echo "â­ï¸ **SKIPPED**" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.fuzzy-test-handlers.outputs.test_passed }}" = "true" ]; then
            echo "âœ… **PASSED**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **FAILED** (exit code: ${{ needs.fuzzy-test-handlers.outputs.exit_code }})" >> $GITHUB_STEP_SUMMARY
            echo "Check artifacts for detailed logs and analysis." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Profiling Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Download the following artifacts for profiling analysis:" >> $GITHUB_STEP_SUMMARY
          echo "- **profiling-data-***: Raw profiling data (perf.data, jemalloc heaps)" >> $GITHUB_STEP_SUMMARY
          echo "- **profiling-reports-***: Generated reports (flamegraphs, memory reports)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’¡ Use the SVG flamegraphs to identify CPU hotspots and memory reports for allocation analysis." >> $GITHUB_STEP_SUMMARY
