name: Release

on:
  push:
    branches:
      - master
    paths:
      - Cargo.toml
      - Cargo.lock
      - "crates/**"
      - ".github/workflows/release.yml"
      - ".github/workflows/deps/**"
      - ".github/actions/**"
  pull_request:
    paths:
      - Cargo.toml
      - Cargo.lock
      - "crates/**"
      - ".github/workflows/deps/**"
      - ".github/actions/**"

permissions:
  contents: read

env:
  BINARIES: |-
    merod
    meroctl
    mero-relayer
    mero-abi
    mero-kms-phala
  AUTH_BINARIES: |-
    mero-auth
  # Binaries to publish to Homebrew (excludes specialized components like mero-kms-phala)
  HOMEBREW_BINARIES: |-
    merod
    meroctl
    mero-relayer
    mero-abi

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-24.04
    outputs:
      version: ${{ steps.version_info.outputs.version }}
      binary_release: ${{ steps.version_info.outputs.binary_release }}
      crate_release: ${{ steps.version_info.outputs.crate_release }}
      docker_release: ${{ steps.version_info.outputs.docker_release }}
      docker_push: ${{ github.event.pull_request && !github.event.pull_request.head.repo.fork || !github.event.pull_request }}
      prerelease: ${{ steps.version_info.outputs.prerelease }}
      target_commit: ${{ steps.version_info.outputs.target_commit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get version info
        id: version_info
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "target_commit=${{ github.sha }}" >> $GITHUB_OUTPUT

          version=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "calimero-version") | .version')

          prerelease=false
          binary_release=false
          crate_release=false
          docker_release=false

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            if [[ "$version" =~ -[a-z]+(\.[0-9]+)?$ ]]; then
              prerelease=true
            fi

            if ! gh release view "$version" --repo ${{ github.repository }} >/dev/null 2>&1; then
              binary_release=true
              crate_release=true
              docker_release=true
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            docker_release=true
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "prerelease=$prerelease" >> $GITHUB_OUTPUT
          echo "binary_release=$binary_release" >> $GITHUB_OUTPUT
          echo "crate_release=$crate_release" >> $GITHUB_OUTPUT
          echo "docker_release=$docker_release" >> $GITHUB_OUTPUT

  build-binaries:
    name: Build Binaries
    needs: prepare
    strategy:
      matrix:
        include:
          - os: ubuntu-24.04
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
      fail-fast: false
    runs-on: ${{ matrix.os }}

    env:
      CALIMERO_WEBUI_FETCH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      CALIMERO_AUTH_FRONTEND_FETCH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup rust cache
        uses: Swatinem/rust-cache@v2
        with:
          key: release

      - name: Update Bash
        if: ${{ matrix.os == 'macos-13' || matrix.os == 'macos-latest' }}
        run: brew install bash

      - name: Build binaries
        run: |
          readarray -t binaries <<< "$BINARIES"
          readarray -t auth_binaries <<< "$AUTH_BINARIES"

          binaries+=("${auth_binaries[@]}")

          binaries=$(printf -- '-p %s ' "${binaries[@]}")

          cargo build $binaries --release --target ${{ matrix.target }}

      - name: Compress artifacts using gzip
        run: |
          mkdir -p artifacts

          readarray -t binaries <<< "$BINARIES"
          readarray -t auth_binaries <<< "$AUTH_BINARIES"

          binaries+=("${auth_binaries[@]}")

          for binary in "${binaries[@]}"; do
            tar -czf artifacts/"$binary"_${{ matrix.target }}.tar.gz -C target/${{ matrix.target }}/release "$binary"
          done

      - name: Build profiling binaries (with frame pointers and debug symbols)
        if: ${{ matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'aarch64-unknown-linux-gnu' }}
        run: |
          readarray -t binaries <<< "$BINARIES"
          binaries=$(printf -- '-p %s ' "${binaries[@]}")

          # Build with frame pointers and enable Wasmer PerfMap profiling feature
          RUSTFLAGS="-C force-frame-pointers=yes" cargo build $binaries --profile profiling --target ${{ matrix.target }} --features calimero-context/profiling

      - name: Compress profiling artifacts using gzip
        if: ${{ matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'aarch64-unknown-linux-gnu' }}
        run: |
          mkdir -p artifacts-profiling

          readarray -t binaries <<< "$BINARIES"

          for binary in "${binaries[@]}"; do
            tar -czf artifacts-profiling/"$binary"_${{ matrix.target }}.tar.gz -C target/${{ matrix.target }}/profiling "$binary"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: artifacts/*
          retention-days: 2

      - name: Upload profiling artifacts
        if: ${{ matrix.target == 'x86_64-unknown-linux-gnu' || matrix.target == 'aarch64-unknown-linux-gnu' }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-profiling-${{ matrix.target }}
          path: artifacts-profiling/*
          retention-days: 2

  release-binaries:
    name: Release Binaries
    if: needs.prepare.outputs.binary_release == 'true'
    runs-on: ubuntu-24.04
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: artifacts/*
          file_glob: true
          tag: ${{ needs.prepare.outputs.version }}
          release_name: ${{ needs.prepare.outputs.version }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          target_commit: ${{ needs.prepare.outputs.target_commit }}

  release-crates:
    name: Release Crates
    if: needs.prepare.outputs.crate_release == 'true'
    runs-on: ubuntu-latest
    needs: [prepare, build-binaries]

    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false

      - name: Checkout core repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Rust installation
        run: rustc --version

      - name: Setup rust cache (publish)
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: release

      - name: Publish calimero-workspaces on crates.io
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: |
          set -x

          sed -i 's/.*# crates_version/version = "'${VERSION}'" # crates_version/' Cargo.toml

          # Install the specific version of cargo-workspaces that we know works
          cargo install --git https://github.com/calimero-network/cargo-workspaces --tag v0.3.0 cargo-workspaces
          # Publish all publishable crates from the workspace, skipping excluded packages
          # Using --no-git flags to avoid git operations during publishing
          cargo ws publish --yes --allow-dirty --force '*' \
              --no-git-commit --no-git-push --no-individual-tags --tag-prefix 'crates-'

  release-merod-container:
    name: Release Merod container
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-merod-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Release
        uses: ./.github/actions/container-release
        with:
          version: ${{ needs.prepare.outputs.version }}
          release: ${{ needs.prepare.outputs.docker_release }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          push: ${{ needs.prepare.outputs.docker_push }}
          binaries: ${{ env.BINARIES }}
          dockerfile: .github/workflows/deps/prebuilt.Dockerfile
          container_name: merod
          github-token: ${{ secrets.GITHUB_TOKEN }}

  release-mero-auth-container:
    name: Release Mero Auth container
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-mero-auth-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Release
        uses: ./.github/actions/container-release
        with:
          version: ${{ needs.prepare.outputs.version }}
          release: ${{ needs.prepare.outputs.docker_release }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          push: ${{ needs.prepare.outputs.docker_push }}
          binaries: ${{ env.AUTH_BINARIES }}
          dockerfile: .github/workflows/deps/prebuilt.auth.Dockerfile
          container_name: mero-auth
          github-token: ${{ secrets.GITHUB_TOKEN }}

  release-mero-kms-phala-container:
    name: Release Mero KMS Phala container
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-mero-kms-phala-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Release
        uses: ./.github/actions/container-release
        with:
          version: ${{ needs.prepare.outputs.version }}
          release: ${{ needs.prepare.outputs.docker_release }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          push: ${{ needs.prepare.outputs.docker_push }}
          binaries: ${{ env.BINARIES }}
          dockerfile: .github/workflows/deps/prebuilt.mero-kms-phala.Dockerfile
          container_name: mero-kms-phala
          github-token: ${{ secrets.GITHUB_TOKEN }}

  release-mero-relayer-container:
    name: Release Mero Relayer container
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-mero-relayer-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Release
        uses: ./.github/actions/container-release
        with:
          version: ${{ needs.prepare.outputs.version }}
          release: ${{ needs.prepare.outputs.docker_release }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          push: ${{ needs.prepare.outputs.docker_push }}
          binaries: mero-relayer
          dockerfile: .github/workflows/deps/prebuilt.relayer.Dockerfile
          container_name: mero-relayer
          github-token: ${{ secrets.GITHUB_TOKEN }}

  release-merod-profiling-container:
    name: Release Merod Profiling container
    needs: [prepare, build-binaries]
    concurrency:
      group: ${{ github.workflow }}-${{ github.job }}-${{ github.ref }}-merod-profiling-${{ needs.prepare.outputs.version }}
      cancel-in-progress: true
    permissions:
      contents: read
      packages: write
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Release
        uses: ./.github/actions/container-release-profiling
        with:
          version: ${{ needs.prepare.outputs.version }}
          release: ${{ needs.prepare.outputs.docker_release }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          push: ${{ needs.prepare.outputs.docker_push }}
          binaries: ${{ env.BINARIES }}
          dockerfile: .github/workflows/deps/prebuilt.profiling.Dockerfile
          container_name: merod
          github-token: ${{ secrets.GITHUB_TOKEN }}

  brew-update:
    name: Update Homebrew Tap
    if: needs.prepare.outputs.binary_release == 'true'
    runs-on: ubuntu-24.04
    needs: [prepare, release-binaries]
    permissions:
      id-token: write
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            homebrew-tap

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/homebrew-tap
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh auth setup-git
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Update Formula
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          target_branch="chore/bump-formulas-version"
          git fetch origin "${target_branch}" || true
          git checkout "${target_branch}" || git checkout -b "${target_branch}"

          readarray -t binaries <<< "$HOMEBREW_BINARIES"

          for binary in "${binaries[@]}"; do
            echo "Updating formula for ${binary}, version: ${{ needs.prepare.outputs.version }}"
            ./generate-formula.sh "${binary}" "${{ needs.prepare.outputs.version }}"
          done

          git status

          if git diff-index --quiet HEAD --; then
            echo "There are no changes to commit"
            exit 1
          fi

          git add Formula/
          git commit -m "chore: bump formulas version"
          git push origin "${target_branch}"

          gh pr create -f || true
