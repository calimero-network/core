name: Release

on:
  push:
    branches:
      - master
    paths:
      - Cargo.toml
      - Cargo.lock
      - 'crates/**'
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master
    paths:
      - Cargo.toml
      - Cargo.lock
      - 'crates/**'
      - '.github/workflows/release.yml'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BINARIES: |-
    merod
    meroctl

jobs:
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version_info.outputs.version }}
      binary_release: ${{ steps.version_info.outputs.binary_release }}
      docker_release: ${{ steps.version_info.outputs.docker_release }}
      prerelease: ${{ steps.version_info.outputs.prerelease }}
      overwrite_release: ${{ steps.version_info.outputs.overwrite_release }}
      target_commit: ${{ steps.version_info.outputs.target_commit }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get version info
        id: version_info
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "target_commit=${{ github.sha }}" >> $GITHUB_OUTPUT

          version=$(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.name == "calimero-version") | .version')

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            if [[ "$version" =~ "-pre.[0-9]+$" ]]; then
              echo "prerelease=true" >> $GITHUB_OUTPUT
              echo "overwrite_release=true" >> $GITHUB_OUTPUT
            elif ! [[ "$version" =~ "-pre$" ]]; then
              echo "prerelease=false" >> $GITHUB_OUTPUT
              echo "overwrite_release=false" >> $GITHUB_OUTPUT
            else
              echo "\x1b[1;31mError\x1b[0m: Missing pre-release version suffix in the version string" > /dev/stderr
              exit 1
            fi

            if gh release view "$version" --repo ${{ github.repository }} >/dev/null 2>&1; then
              echo "binary_release=false" >> $GITHUB_OUTPUT
              echo "docker_release=false" >> $GITHUB_OUTPUT
            else
              echo "binary_release=true" >> $GITHUB_OUTPUT
              echo "docker_release=true" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # todo! a cron job should delete pr- docker images after some time
            version="pr-${{ github.event.number }}"

            echo "binary_release=false" >> $GITHUB_OUTPUT
            echo "docker_release=true" >> $GITHUB_OUTPUT
          fi

  build-binaries:
    name: Build Binaries
    needs: prepare
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
          - os: macos-13
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup rust cache
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: rust-binaries
          shared-key: ${{ matrix.target }}

      - name: Build binaries
        run: |
          readarray -t binaries <<< "$BINARIES"

          binaries=$(printf -- '-p %s ' "${binaries[@]}")

          cargo build $binaries --release --target ${{ matrix.target }}

      - name: Compress artifacts using gzip
        run: |
          mkdir -p artifacts

          readarray -t binaries <<< "$BINARIES"

          for binary in "${binaries[@]}"; do
            tar -czf artifacts/"$binary"_${{ matrix.target }}.tar.gz -C target/${{ matrix.target }}/release "$binary"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.target }}
          path: artifacts/*
          retention-days: 2

  release-binaries:
    name: Release Binaries
    if: needs.prepare.outputs.binary_release == 'true'
    runs-on: ubuntu-latest
    needs: [prepare, build-binaries]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: Upload binaries to release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: artifacts/*
          file_glob: true
          tag: ${{ needs.prepare.outputs.version }}
          release_name: ${{ needs.prepare.outputs.version }}
          prerelease: ${{ needs.prepare.outputs.prerelease }}
          overwrite: ${{ needs.prepare.outputs.overwrite_release }}
          target_commit: ${{ needs.prepare.outputs.target_commit }}

  build-docker:
    name: Build Docker Images
    needs: [prepare, build-binaries]
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        image:
          - name: merod
            description: Merod container image
          - name: meroctl
            description: Meroctl - Control tool for Merod container image

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built binaries
        uses: actions/download-artifact@v4
        with:
          path: binaries/
          merge-multiple: true

      - name: Extract Linux binaries
        run: |
          # Create architecture-specific directories
          mkdir -p ./bin/amd64 ./bin/arm64

          # Extract binaries directly to the proper directories
          tar -xzf binaries/${{ matrix.image.name }}_x86_64-unknown-linux-gnu.tar.gz -C ./bin/amd64 --no-same-owner
          tar -xzf binaries/${{ matrix.image.name }}_aarch64-unknown-linux-gnu.tar.gz -C ./bin/arm64 --no-same-owner

          # Ensure binaries have correct permissions
          chmod +x ./bin/amd64/${{ matrix.image.name }} ./bin/arm64/${{ matrix.image.name }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest
            network=host

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare Docker Cache parameters
        id: prepare
        run: |
          MASTER_SCOPE="${{ github.repository_owner }}-docker-master"
          DEV_SCOPE="${{ github.repository_owner }}-docker-dev"

          if [ "${{ github.ref }}" == "refs/heads/master" ]; then
            echo "cache_from=type=gha,scope=${MASTER_SCOPE}" >> $GITHUB_OUTPUT
            echo "cache_to=type=gha,scope=${MASTER_SCOPE},mode=max" >> $GITHUB_OUTPUT
          else
            echo "cache_from=type=gha,scope=${MASTER_SCOPE} type=gha,scope=${DEV_SCOPE}" >> $GITHUB_OUTPUT
            echo "cache_to=type=gha,scope=${DEV_SCOPE},mode=max" >> $GITHUB_OUTPUT
          fi

          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Extract metadata for ${{ matrix.image.name }}
        id: metadata
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ matrix.image.name }}
          tags: |
            type=raw,value=${{ steps.prepare.outputs.short_sha }}
            type=raw,value=${{ needs.prepare.outputs.version }},enable=${{ needs.prepare.outputs.docker_release == 'true' }}
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/master' && needs.prepare.outputs.docker_release == 'true' }}

      - name: Build and push ${{ matrix.image.name }} image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./.github/workflows/deps/prebuilt.Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            BINARY_NAME=${{ matrix.image.name }}
          tags: ${{ steps.metadata.outputs.tags }}
          labels: ${{ steps.metadata.outputs.labels }}
          cache-from: ${{ steps.prepare.outputs.cache_from }}
          cache-to: ${{ steps.prepare.outputs.cache_to }}
          provenance: mode=max
          sbom: true
          annotations: |
            org.opencontainers.image.description=${{ matrix.image.description }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.licenses=MIT

  brew-update:
    name: Update Homebrew Tap
    if: needs.prepare.outputs.binary_release == 'true'
    runs-on: ubuntu-latest
    needs: [prepare, release-binaries]
    permissions:
      id-token: write
    steps:
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ vars.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: |
            homebrew-tap

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/homebrew-tap
          token: ${{ steps.app-token.outputs.token }}
          persist-credentials: false

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh auth setup-git
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Update Formula
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          target_branch="chore/bump-formulas-version"
          git fetch origin "${target_branch}" || true
          git checkout "${target_branch}" || git checkout -b "${target_branch}"

          readarray -t binaries <<< "$BINARIES"

          for binary in "${binaries[@]}"; do
            echo "Updating formula for ${binary}, version: ${version}"
            ./generate-formula.sh "${binary}" "${{ needs.prepare.outputs.version }}"
          done

          git status

          if git diff-index --quiet HEAD --; then
            echo "There are no changes to commit"
            exit 1
          fi

          git add Formula/
          git commit -m "chore: bump formulas version"
          git push origin "${target_branch}"

          gh pr create -f || true
