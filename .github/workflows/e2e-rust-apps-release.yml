name: E2E - Rust Apps (Released Image)

# Tests all Rust SDK apps using the released Docker image from GHCR.
# Validates that released images work correctly on master merges.
# For fast PR testing with locally-built images, see e2e-rust-apps.yml

permissions:
  contents: read

on:
  push:
    branches: [master]
    paths:
      - "crates/**"
      - "apps/**"
      - ".github/workflows/e2e-rust-apps-release.yml"

  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CALIMERO_CONTRACTS_VERSION: "latest"
  CARGO_TARGET_DIR: ${{ github.workspace }}/target

jobs:
  build-apps:
    name: Build Apps
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust CI
        uses: ./.github/actions/setup-rust-ci
        with:
          toolchain: stable
          shared-key: e2e-rust-apps-release
          save-if: ${{ github.ref == 'refs/heads/master' }}

      - name: Build all apps
        run: ./scripts/build-all-apps.sh

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-rust-apps-release-build-artifacts
          path: |
            target/app-release
            apps/*/res/*.wasm
            apps/*/res/*.mpk
          retention-days: 1

  test:
    name: Run All Merobox Workflows
    needs: build-apps
    runs-on: ubuntu-24.04-8cpu
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: e2e-rust-apps-release-build-artifacts

      - name: Determine Docker image tag
        id: image-tag
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./scripts/determine-image-tag.sh \
              "${{ github.event_name }}" \
              "${{ github.event.number }}" \
              "${{ github.repository_owner }}" \
              "${{ github.repository }}" \
              "${{ github.head_ref }}" \
              "$GH_TOKEN"

      - name: Setup merobox
        uses: ./.github/actions/setup-merobox-pypi

      - name: Download Contracts
        uses: ./.github/actions/download-contracts

      - name: Run All Workflows
        id: run_workflows
        run: |
          mkdir -p docker-logs
          cd apps
          failed_workflows=()
          for workflow in */workflows/*.yml */workflows/*.yaml; do
              if [ -f "$workflow" ]; then
                  app_dir=$(dirname "$(dirname "$workflow")")
                  workflow_file=$(basename "$workflow")
                  max_attempts=2
                  attempt=1
                  success=false
                  
                  while [ $attempt -le $max_attempts ]; do
                      if [ $attempt -gt 1 ]; then
                          merobox stop --all || true
                          merobox nuke --force || true
                          sleep 2
                      fi
                      
                      if (
                          cd "$app_dir"
                          merobox bootstrap run \
                              "workflows/$workflow_file" \
                              --image ghcr.io/calimero-network/merod:${{ steps.image-tag.outputs.tag }} \
                              --e2e-mode \
                              --near-devnet \
                              --contracts-dir "$GITHUB_WORKSPACE/contracts/near"
                      ); then
                          success=true
                          break
                      else
                          attempt=$((attempt + 1))
                      fi
                  done
                  
                  # Collect logs
                  workflow_id=$(echo "$workflow" | sed 's|/|-|g' | sed 's|\.yml$||')
                  for container in $(docker ps -a --filter "label=calimero.node=true" --format "{{.Names}}" 2>/dev/null || true); do
                      if [ -n "$container" ]; then
                          docker logs "$container" > "$GITHUB_WORKSPACE/docker-logs/${workflow_id}-${container}.log" 2>&1 || true
                      fi
                  done
                  
                  merobox stop --all || true
                  merobox nuke --force || true
                  if [ "$success" = false ]; then
                      failed_workflows+=("$workflow")
                  fi
                  sleep 2
              fi
          done

          if [ ${#failed_workflows[@]} -gt 0 ]; then
              echo "has_failures=true" >> $GITHUB_OUTPUT
              printf '%s\n' "${failed_workflows[@]}" > failed_workflows.txt
          else
              echo "has_failures=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Failed Workflows
        if: steps.run_workflows.outputs.has_failures == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-rust-apps-release-failed-workflows
          path: apps/failed_workflows.txt
          retention-days: 1

      - name: Upload Workflow Data Artifacts
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: e2e-rust-apps-release-data-${{ github.sha }}
          path: |
            apps/*/res/*.wasm
            apps/*/res/abi.json
            apps/*/res/*.mpk
            apps/*/res/state-schema.json
            apps/*/data/
          retention-days: 7
          if-no-files-found: warn

      - name: Upload Docker Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-rust-apps-release-docker-logs-${{ github.sha }}
          path: docker-logs/
          retention-days: 7
          if-no-files-found: warn

      - name: Fail if workflows failed
        if: steps.run_workflows.outputs.has_failures == 'true'
        run: exit 1
