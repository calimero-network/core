name: Tidy Docker

# Remove all docker images from github registry that match;
#
# 1. <sha> or <untagged> older than 2 days
# 2. <pr-NUMBER> older than 5 days
# 3. anything that isn't `latest`, `edge` or a release tag

on:
  schedule:
    - cron: "0 0 */2 * *" # Every 2 days at 00:00 UTC
  workflow_dispatch:
  push:
    branches:
      - miraclx/pull-node-ui-on-build

concurrency:
  group: tidy-docker
  cancel-in-progress: true

permissions:
  packages: write

env:
  PERSIST: ^edge|latest|(\d+\.\d+\.\d+(-pre\.\d+)?)$

jobs:
  clean:
    name: Clean Docker Images
    runs-on: ubuntu-latest
    steps:
      - uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          package: merod
          use-regex: true
          exclude-tags: ${{ env.PERSIST }}|^pr-\d+$
          keep-n-tagged: 0
          delete-untagged: true
          older-than: 2 days
          delete-orphaned-images: true
          delete-partial-images: true
          validate: true

      - name: Get open PRs
        id: prepare
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          prs=( $(gh pr list --state open --json number -q '.[].number') )

          echo "Found open PRs: ${prs[@]}"
          expr="$(IFS='|'; echo "${prs[*]}")"

          echo "Regex for PRs: $expr"
          echo "active_prs=$expr" >> $GITHUB_OUTPUT

      - uses: dataaxiom/ghcr-cleanup-action@v1
        with:
          package: merod
          use-regex: true
          delete-tags: pr-\d+
          exclude-tags: ^pr-(${{ steps.prepare.outputs.active_prs }})$
          older-than: 5 days
