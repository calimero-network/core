name: PR Description

on:
  pull_request:
    types: [opened, edited]

permissions:
  pull-requests: write
  contents: read

env:
  REQUIRED_SECTIONS: |
    ## Description
    ## Test Plan
    ## Documentation Update

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    if: github.actor != 'dependabot[bot]'
    outputs:
      comment_action: ${{ steps.validate_description.outputs.comment_action }}
      comment_content: ${{ steps.validate_description.outputs.comment_content }}
      is_valid: ${{ steps.validate_description.outputs.is_valid }}
    steps:
      - name: Validate Description
        id: validate_description
        run: |
          readarray -t required_sections <<< "$REQUIRED_SECTIONS"
          pr_body_base64=$(echo -n "${{ github.event.pull_request.body }}" | base64 -w0)
          missing_sections=()

          for section in "${required_sections[@]}"; do
            if ! echo "$pr_body_base64" | base64 --decode | grep -q -i "$section"; then
              missing_sections+=("$section")
            fi
          done

          if [[ ${#missing_sections[@]} -gt 0 ]]; then
            EOF=$(openssl rand -hex 9)
            echo "comment_content<<$EOF" >> "$GITHUB_OUTPUT"
            echo -e "**❌ The PR description is missing these required sections:**\n" >> "$GITHUB_OUTPUT"
            for section in "${missing_sections[@]}"; do
              echo "- \`$section\`" >> "$GITHUB_OUTPUT"
            done
            echo -e "\n**This PR is blocked until this is fixed.**" >> "$GITHUB_OUTPUT"
            echo "$EOF" >> $GITHUB_OUTPUT

            echo "comment_action=recreate" >> "$GITHUB_OUTPUT"
            echo "is_valid=false" >> "$GITHUB_OUTPUT"
          else
            echo "comment_action=delete" >> "$GITHUB_OUTPUT"
            echo "comment_content=" >> "$GITHUB_OUTPUT"
            echo "is_valid=true" >> "$GITHUB_OUTPUT"
          fi

  update-comment:
    name: Report
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - name: Post PR Comment
        uses: thollander/actions-comment-pull-request@v3
        with:
          pr-number: ${{ github.event.pull_request.number }}
          comment-tag: pr-description-check
          mode: ${{ needs.validate.outputs.comment_action }}
          message: ${{ needs.validate.outputs.comment_content }}

      - name: Fail job if PR description is invalid
        if: needs.validate.outputs.is_valid == 'false'
        run: exit 1
