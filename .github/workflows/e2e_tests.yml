name: End-to-end tests

on:
  push:
    branches:
      - '**'
    paths:
      - Cargo.toml
      - Cargo.lock
      - 'contracts/**'
      - 'crates/**'
      - 'e2e-tests/**'
      - '.github/workflows/e2e_tests.yml'

jobs:
  build:
    name: Build Apps & Binaries
    runs-on: ubuntu-latest
    outputs:
      SWARM_PORT: ${{ steps.prepare_e2e_tests_config.outputs.SWARM_PORT }}
      SERVER_PORT: ${{ steps.prepare_e2e_tests_config.outputs.SERVER_PORT }}
      ICP_PORT: ${{ steps.prepare_e2e_tests_config.outputs.ICP_PORT }}
      SWARM_HOST: ${{ steps.prepare_e2e_tests_config.outputs.SWARM_HOST }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust & Cache
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true
          cache-all-crates: true

      - name: Build Apps & Binaries
        run: |
          ./apps/kv-store/build.sh
          cargo build -p meroctl -p merod -p e2e-tests

      - name: Prepare e2e-tests Config
        id: prepare_e2e_tests_config
        run: |
          random_numbers=()
          while [ ${#random_numbers[@]} -lt 3 ]; do
            num=$((RANDOM%37001 + 3000))
            if [[ ! " ${random_numbers[@]} " =~ " ${num} " ]]; then
              random_numbers+=($num)
            fi
          done
          SWARM_PORT="${random_numbers[0]}"
          SERVER_PORT="${random_numbers[1]}"
          ICP_PORT="${random_numbers[2]}"
          SWARM_HOST=$(hostname -I | awk '{print $1}')
          echo "SWARM_PORT=$SWARM_PORT" >> $GITHUB_OUTPUT
          echo "SERVER_PORT=$SERVER_PORT" >> $GITHUB_OUTPUT
          echo "ICP_PORT=$ICP_PORT" >> $GITHUB_OUTPUT
          echo "SWARM_HOST=$SWARM_HOST" >> $GITHUB_OUTPUT

          jq --arg swarmPort "$SWARM_PORT" \
             --arg serverPort "$SERVER_PORT" \
             --arg icpPort "$ICP_PORT" \
             --arg swarmHost "$SWARM_HOST" \
             '.network.swarmHost = $swarmHost |
              .network.startSwarmPort = ($swarmPort | tonumber) |
              .network.startServerPort = ($serverPort | tonumber) |
              .protocolSandboxes[1].config.rpcUrl = "http://127.0.0.1:\($icpPort)"' \
             e2e-tests/config/config.json > e2e-tests/config/config.tmp && mv e2e-tests/config/config.tmp e2e-tests/config/config.json

      - name: Upload Build Artifacts (Binaries)
        uses: actions/upload-artifact@v4
        with:
          name: resources
          path: |
            target/debug/meroctl
            target/debug/merod
            target/debug/e2e-tests
            apps/kv-store/res/kv_store.wasm
            e2e-tests/config/config.json
          retention-days: 2

  test:
    needs: build
    name: "Test ${{ matrix.protocol }}"
    runs-on: ubuntu-latest
    strategy:
      matrix:
        protocol: [near, icp, stellar]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Binaries
        uses: actions/download-artifact@v4
        with:
          name: resources
          path: |
            target/debug/meroctl
            target/debug/merod
            target/debug/e2e-tests
            apps/kv-store/res/kv_store.wasm
            e2e-tests/config/config.json

      - name: Setup Protocol-Specific Dependencies
        run: |
          if [[ "${{ matrix.protocol }}" == "icp" ]]; then
            cargo install candid-extractor
            curl -fsSL https://sdk.dfinity.org/install.sh | bash
          fi

      - name: Build Contracts (if needed)
        run: |
          if [[ "${{ matrix.protocol }}" == "near" ]]; then
            ./contracts/near/context-config/build.sh
            ./contracts/near/context-proxy/build.sh
          elif [[ "${{ matrix.protocol }}" == "stellar" ]]; then
            ./contracts/stellar/context-config/build.sh
            ./contracts/stellar/context-proxy/build.sh
          fi

      - name: Deploy Local Devnet (if needed)
        run: |
          if [[ "${{ matrix.protocol }}" == "icp" ]]; then
            cd ./contracts/icp/context-config
            ICP_PORT=${{ needs.build.outputs.ICP_PORT }} ./deploy_devnet.sh
            cd ../../..
          elif [[ "${{ matrix.protocol }}" == "stellar" ]]; then
            chmod +x ./contracts/stellar/context-config/deploy_devnet_env.sh
            chmod +x e2e-tests/config/config.json

            ./contracts/stellar/context-config/deploy_devnet_env.sh > env_output.txt
            
            CONTRACT_ID=$(grep "Contract ID:" env_output.txt | awk '{print $3}')
            ACCOUNT_ADDRESS=$(grep "Account address:" env_output.txt | awk '{print $3}')
            SECRET_KEY=$(grep "Secret key:" env_output.txt | awk '{print $3}')
            
            jq --arg contractId "$CONTRACT_ID" --arg publicKey "$ACCOUNT_ADDRESS" --arg secretKey "$SECRET_KEY" \
              '.protocolSandboxes[2].config.contextConfigContractId = $contractId |
               .protocolSandboxes[2].config.publicKey = $publicKey |
               .protocolSandboxes[2].config.secretKey = $secretKey' \
              e2e-tests/config/config.json > tmp.json && mv tmp.json e2e-tests/config/config.json
          fi

      - name: Run e2e Tests
        env:
          NO_COLOR: '1'
          SWARM_HOST: ${{ needs.build.outputs.SWARM_HOST }}
          ICP_PORT: ${{ needs.build.outputs.ICP_PORT }}
        run: |
          echo "Running e2e tests for ${{ matrix.protocol }}"
          chmod +x ./target/debug/e2e-tests
          chmod +x ./target/debug/merod
          chmod +x ./target/debug/meroctl

          ./target/debug/e2e-tests \
            --input-dir ./e2e-tests/config \
            --output-dir ./e2e-tests/corpus \
            --merod-binary ./target/debug/merod \
            --meroctl-binary ./target/debug/meroctl \
            --protocols ${{ matrix.protocol }}

      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: e2e-tests-${{ matrix.protocol }}
          path: e2e-tests/corpus/
          retention-days: 2
