name: Build and Verify WASM

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

permissions:
  contents: read

jobs:
  build-and-verify:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Build Apps
        shell: bash
        run: |
          set -e

          # Loop through direct children of apps/
          for dir in apps/*/; do
            if [ -f "${dir}build.sh" ]; then
              echo "Building: $dir"
              chmod +x "${dir}build.sh"
              (cd "$dir" && ./build.sh)
            fi
          done

      - name: Check for WASM mismatches
        shell: bash
        run: |
          echo "Checking for modified or untracked .wasm files..."

          # Look for .wasm files that were not committed or changed
          DIFF_LIST=$(git status --porcelain --ignored --untracked-files=all | grep '\.wasm' | awk '{print $1 " " $2}' || true)

          if [ -n "$DIFF_LIST" ]; then
            echo "-------------------------------------------------------"
            echo "❌ ERROR: The following apps binary .wasm files require attention:"
            echo ""
            echo "$DIFF_LIST"
            echo ""
            echo "Legend:"
            echo " M  = Modified (Repo version is outdated)"
            echo " ?? = Untracked (New file, not yet added to Git)"
            echo " !! = Ignored (Found in .gitignore but differs from build)"
            echo "-------------------------------------------------------"
            echo "Action: Run build.sh locally and commit these files."
            exit 1
          else
            echo "✅ All apps binary files match the repository state."
          fi
