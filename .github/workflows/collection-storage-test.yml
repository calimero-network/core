name: Collection Storage Test

on:
  push:
    branches: ["master"]
    paths:
      - "apps/collection-storage-test/**"
      - "crates/storage/**"
      - "workflows/collection-storage-test.yml"
      - "Cargo.toml"
      - "Cargo.lock"
  pull_request:
    paths:
      - "apps/collection-storage-test/**"
      - "crates/storage/**"
      - "workflows/collection-storage-test.yml"
      - "Cargo.toml"
      - "Cargo.lock"

env:
  CALIMERO_WEBUI_FETCH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

permissions:
  contents: read

jobs:
  build-and-test:
    name: Build and Test Collection Storage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install WASM target
        run: |
          echo "🔧 Installing WASM target..."
          rustup target add wasm32-unknown-unknown
          echo "✅ WASM target installed"
          rustup target list --installed | grep wasm32-unknown-unknown || echo "❌ WASM target not found in installed targets"

      - name: Verify Rust installation
        run: rustc --version

      - name: Setup Rust Cache
        uses: Swatinem/rust-cache@v2
        with:
          key: collection-storage-test

      - name: Install Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Collection Storage Test App
        run: |
          echo "🔨 Building collection-storage-test application..."
          
          # Debug: Check current directory and Rust setup
          echo "📁 Current directory: $(pwd)"
          echo "🔧 Rust version: $(rustc --version)"
          echo "🎯 Available targets:"
          rustup target list --installed | head -10
          
          cd apps/collection-storage-test
          echo "📁 Changed to: $(pwd)"
          
          # Debug: Check if build script exists and is executable
          ls -la build.sh
          
          ./build.sh
          cd ../..
          
          echo "✅ Application built successfully"
          ls -la apps/collection-storage-test/res/
          
          # Verify the WASM file exists and has content
          if [ ! -f "apps/collection-storage-test/res/collection_storage_test.wasm" ]; then
            echo "❌ WASM file not found!"
            exit 1
          fi
          
          WASM_SIZE=$(stat -c%s "apps/collection-storage-test/res/collection_storage_test.wasm")
          echo "📦 WASM file size: $WASM_SIZE bytes"
          
          if [ $WASM_SIZE -lt 1000 ]; then
            echo "❌ WASM file seems too small, might be corrupted!"
            exit 1
          fi
          
          # Copy the WASM file to workflows directory for the workflow to use
          cp apps/collection-storage-test/res/collection_storage_test.wasm workflows/
          echo "📋 WASM file copied to workflows directory"

      - name: Build Docker Image
        run: |
          echo "🐳 Building Docker image with current commit..."
          
          # Create a unique image tag based on commit SHA
          IMAGE_TAG="merod-sdk-test-collection-fix:$(git rev-parse --short HEAD)"
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
          
          docker build -t $IMAGE_TAG .
          
          echo "✅ Docker image built successfully"
          docker images | grep merod-sdk-test-collection-fix

      - name: Install Merobox
        run: |
          echo "📦 Installing Merobox..."
          
          # Try to get the latest release info
          echo "🔍 Checking latest Merobox release..."
          curl -s https://api.github.com/repos/calimero-network/merobox/releases/latest | grep -o '"tag_name": "[^"]*"' | head -1
          
          # Download with verbose output and follow redirects
          echo "📥 Downloading Merobox..."
          curl -L -v https://github.com/calimero-network/merobox/releases/latest/download/merobox-linux-x86_64 -o merobox
          
          # Check file size and content
          echo "📊 Downloaded file size: $(stat -c%s merobox 2>/dev/null || echo 'unknown') bytes"
          echo "🔍 First few lines of downloaded file:"
          head -5 merobox 2>/dev/null || echo "File is empty or unreadable"
          
          chmod +x merobox
          sudo mv merobox /usr/local/bin/
          
          echo "✅ Merobox installed successfully"
          merobox --version

      - name: Generate Dynamic Workflow
        run: |
          echo "🔧 Generating dynamic workflow with current image tag..."
          
          # Create a dynamic workflow file with the current image tag
          sed "s|IMAGE_PLACEHOLDER|$IMAGE_TAG|g" workflows/collection-storage-test-ci.yml > workflows/collection-storage-test-dynamic.yml
          
          echo "✅ Dynamic workflow generated"
          echo "📋 Generated workflow file (first 15 lines):"
          cat workflows/collection-storage-test-dynamic.yml | head -15
          
          echo ""
          echo "🔍 Image tag that will be used: $IMAGE_TAG"

      - name: Run Collection Storage Test Workflow
        run: |
          echo "🧪 Running collection storage test workflow..."
          
          # Set up test environment
          export RUST_LOG=calimero_storage=debug
          
          # Run the dynamically generated workflow
          if ! merobox bootstrap run workflows/collection-storage-test-dynamic.yml; then
            echo "❌ Workflow failed!"
            
            # Show logs for debugging
            echo "📋 Checking for log files..."
            find . -name "*.log" -type f | head -5 | xargs -I {} echo "Log file: {}" || true
            
            # Show container status
            echo "🐳 Container status:"
            docker ps -a || true
            
            exit 1
          fi
          
          echo "✅ Workflow completed successfully"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: collection-storage-test-results
          path: |
            data/
            *.log
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          echo "🧹 Cleaning up test environment..."
          docker stop $(docker ps -q) 2>/dev/null || true
          docker rm $(docker ps -aq) 2>/dev/null || true
          rm -rf data/ || true
