name: Calimero Crates Publish

on:
  push:
    branches:
      - master

jobs:
  publish-cargo-crates:
    name: "Publish calimero-workspaces on crates.io"
    runs-on: ubuntu-latest
    environment: deploy
    permissions:
      contents: write # required for crates push
    
    steps:
      - name: Checkout core repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Set up git user
        uses: fregante/setup-git-user@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Verify Rust installation
        run: rustc --version

      - name: Check if version is already published
        id: version-check
        run: |
          # Extract package name and version from workspace metadata
          VERSION=$(cargo metadata --format-version 1 | jq -r '.metadata.workspaces.version // empty' 2>/dev/null || echo "")
          
          if [ -z "$VERSION" ]; then
            echo "ERROR: Failed to extract version. Exiting."
            exit 1
          fi
          
          echo "Publishing version: $VERSION"
          
          # Extract package name from workspace metadata
          
          # Check if version is already published
          CRATES_RESPONSE=$(curl -s  --user-agent "calimero-publish-workflow" "https://crates.io/api/v1/crates/calimero-primitives/versions")
          echo "API Response preview: $(echo "$CRATES_RESPONSE" | head -c 200)..."
          
          # Check if API response contains errors
          if echo "$CRATES_RESPONSE" | jq -e '.errors' >/dev/null 2>&1; then
            echo "ERROR: crates.io API returned errors, cannot verify version status"
            echo "API Response: $CRATES_RESPONSE"
            exit 1
          else
            PUBLISHED=$(echo "$CRATES_RESPONSE" | jq -r ".versions[] | select(.num == \"$VERSION\") | .num // empty" 2>/dev/null || echo "")
            echo "Debug: VERSION=$VERSION, PUBLISHED=$PUBLISHED"
          fi
          
          echo "Published version: $PUBLISHED" 
          
          if [ "$PUBLISHED" = "$VERSION" ]; then
            echo "Version $VERSION is already published. Skipping publish steps."
            echo "skip_publish=true" >> $GITHUB_OUTPUT
          else
            echo "Version $VERSION is not yet published. Proceeding with publish."
            echo "skip_publish=false" >> $GITHUB_OUTPUT
          fi

      - name: Publish calimero-workspaces on crates.io
        if: steps.version-check.outputs.skip_publish != 'true'
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
        run: |
          set -x
          # Install the specific version of cargo-workspaces that we know works
          cargo install --git https://github.com/miraclx/cargo-workspaces --tag v0.3.0 cargo-workspaces
          # Publish all publishable crates from the workspace, skipping excluded packages
          # Using --no-git flags to avoid git operations during publishing
          cargo ws publish --yes --allow-dirty --force '*' \
              --no-git-commit --no-git-push --no-individual-tags --tag-prefix 'crates-' \
              --tag-msg $$'crates.io snapshot\n---%{\n- %n - https://crates.io/crates/%n/%v}'

      - name: Create tag on https://github.com/calimero-network/core
        if: steps.version-check.outputs.skip_publish != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --no-follow-tags https://github.com/calimero-network/core.git tag 'crates-*'
