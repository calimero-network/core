name: Rust

on:
  push:
    branches: ['master']
  pull_request:
    branches: ['master']

env:
  CARGO_TERM_COLOR: always
  CARGO_HOME:
  RUSTUP_HOME:
  PNPM_HOME:
  ALT_HOME:
  STAGE_DIR:

jobs:
  setup:
    name: Project setup
    runs-on: ubuntu-latest
    steps:
      - name: Prepare
        run: |
          export STAGE_DIR=$(dirname $GITHUB_WORKSPACE)
          echo "STAGE_DIR=$STAGE_DIR" >> $GITHUB_ENV
          export ALT_HOME="$STAGE_DIR/.home"
          echo "ALT_HOME=$ALT_HOME" >> $GITHUB_ENV
          mkdir -p $ALT_HOME
      
      - name: Maximize build space
        uses: easimon/maximize-build-space@v10
        with:
          build-mount-path: ${{ env.STAGE_DIR }}
          root-reserve-mb: 4096

      - name: Relocate environment
        run: |
          echo "CARGO_HOME=$ALT_HOME/.cargo" >> $GITHUB_ENV
          echo "RUSTUP_HOME=$ALT_HOME/.rustup" >> $GITHUB_ENV
          echo "PNPM_HOME=$ALT_HOME/.pnpm" >> $GITHUB_ENV
          
          mv ~/.cargo $ALT_HOME
          mv ~/.rustup $ALT_HOME
          echo "$ALT_HOME/.cargo/bin" | cat - $GITHUB_PATH > temp && mv temp $GITHUB_PATH

      - name: Check environment
        run: |
          echo $PATH
          which rustup
          rustup --version

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check environment
        run: |
          echo $PATH
          which rustup
          rustup --version

      - name: How're we looking?
        run: |
          df -h

      # Install Node.js (version 20) and pnpm
      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '20'

      - name: How're we looking?
        run: |
          df -h

      - name: Install pnpm
        run: npm install -g pnpm

      - name: How're we looking?
        run: |
          df -h

      # Install and build node-ui
      - name: Install node-ui dependencies with pnpm
        run: pnpm install --prefix ./node-ui

      - name: How're we looking?
        run: |
          df -h

      - name: Build node-ui
        run: pnpm --filter ./node-ui run build

      - name: How're we looking?
        run: |
          df -h

      - name: Check environment
        run: |
          echo $PATH
          which rustup
          rustup --version
          
      - name: Setup rust toolchain
        run: rustup toolchain install stable --profile minimal

      - name: How're we looking?
        run: |
          df -h

      - name: Setup rust cache
        uses: Swatinem/rust-cache@v2

      - name: How're we looking?
        run: |
          df -h
        
      - name: Run code style checks
        uses: ./.github/actions/style

      - name: How're we looking?
        run: |
          df -h

      - name: Build
        run: cargo build --verbose
      
      - name: How're we looking?
        run: |
          df -h

      - name: Run tests
        run: |
          chmod +x $GITHUB_WORKSPACE/scripts/build-all-apps.sh
          chmod +x $GITHUB_WORKSPACE/scripts/test.sh
          $GITHUB_WORKSPACE/scripts/test.sh

      - name: How're we looking?
        run: |
          df -h
