services:
  # Auth service
  auth:
    build:
      context: .
      dockerfile: Dockerfile.auth
      target: runtime
      secrets:
        - gh-token
    user: root
    volumes:
      - calimero_auth_data:/data
    environment:
      - RUST_LOG=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/auth/health"]
      interval: 30s
      timeout: 10s
    networks:
      - internal
      - web
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"

      # Auth service on localhost (both /auth/ and /admin/)
      - "traefik.http.routers.auth-public.rule=Host(`localhost`) && (PathPrefix(`/auth/`) || PathPrefix(`/admin/`))"
      - "traefik.http.routers.auth-public.entrypoints=web"
      - "traefik.http.routers.auth-public.service=auth-service"
      - "traefik.http.routers.auth-public.middlewares=cors,auth-headers"
      - "traefik.http.routers.auth-public.priority=100"

      # Add Node ID header for auth service
      - "traefik.http.middlewares.auth-headers.headers.customrequestheaders.X-Node-ID=auth"

      # Define the service
      - "traefik.http.services.auth-service.loadbalancer.server.port=3001"

      # CORS middleware
      - "traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE"
      - "traefik.http.middlewares.cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.cors.headers.addvaryheader=true"
      - "traefik.http.middlewares.cors.headers.accesscontrolexposeheaders=X-Auth-Error"

  # Reverse proxy
  proxy:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--accesslog=true"
      - "--log.level=DEBUG"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.network=${COMPOSE_PROJECT_NAME:-calimero}_web"
      - "--serversTransport.forwardingTimeouts.dialTimeout=30s"
      - "--serversTransport.forwardingTimeouts.responseHeaderTimeout=30s"
      - "--serversTransport.forwardingTimeouts.idleConnTimeout=30s"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Proxy dashboard
      - "traefik.http.routers.proxy-dashboard.rule=Host(`proxy.127.0.0.1.nip.io`)"
      - "traefik.http.routers.proxy-dashboard.entrypoints=web"
      - "traefik.http.routers.proxy-dashboard.service=api@internal"

networks:
  web:
    driver: bridge
  internal:
    internal: true

volumes:
  calimero_auth_data:
    driver: local

secrets:
  gh-token:
    environment: GH_TOKEN