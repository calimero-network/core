name: "Private Data - NEAR"
description: "Test private data functionality on NEAR protocol"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: private-data-near

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install Private Data Application on Node 1
    type: install_application
    node: private-data-near-1
    path: "apps/private_data/res/private_data.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: private-data-near-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{member_public_key}})"

  - name: Create Identity on Node 2
    type: create_identity
    node: private-data-near-2
    outputs:
      public_key: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 2

  # ============================================
  # Invitation Phase: Invite and join
  # ============================================
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: private-data-near-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation: invitation

  - name: Join Context from Node 2
    type: join_context
    node: private-data-near-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key}}"
    invitation: "{{invitation}}"

  - name: Wait for join completion
    type: wait
    seconds: 2

  # ============================================
  # Testing Phase: Private data operations
  # ============================================
  - name: Store Secret from Node 1
    type: call
    node: private-data-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: store_secret
    args:
      key: "my_secret"
      value: "secret_value"

  - name: Wait for secret storage
    type: wait
    seconds: 2

  - name: View Secrets on Node 1
    type: call
    node: private-data-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: view_secrets
    outputs:
      secrets_node1: result

  - name: Assert secret stored on Node 1
    type: assert
    statements:
      - "is_set({{secrets_node1}})"

  - name: Try to View Secrets from Node 2 (should be private)
    type: call
    node: private-data-near-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: view_secrets
    outputs:
      secrets_node2: result

  - name: Assert secrets are private to Node 2
    type: json_assert
    statements:
      - 'json_equal({{secrets_node2}}, {"output": {}})'

# Configuration options
stop_all_nodes: true
restart: false
wait_timeout: 45
nuke_on_end: true