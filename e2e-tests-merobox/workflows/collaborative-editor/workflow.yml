name: "Collaborative Editor - NEAR"
description: "CRDT-based collaborative text editing test on NEAR protocol"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: collab-near

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install Collaborative Editor on Node 1
    type: install_application
    node: collab-near-1
    path: "apps/collaborative-editor/res/collaborative_editor.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: collab-near-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{member_public_key}})"

  - name: Create Identity on Node 2
    type: create_identity
    node: collab-near-2
    outputs:
      public_key: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 3

  # ============================================
  # Invitation Phase: Invite and join
  # ============================================
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: collab-near-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation: invitation

  - name: Join Context from Node 2
    type: join_context
    node: collab-near-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key}}"
    invitation: "{{invitation}}"

  # ============================================
  # Testing Phase: Collaborative Editing
  # ============================================
  - name: Get Initial Text (Node 1)
    type: call
    node: collab-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_text
    outputs:
      initial_text: result

  - name: Assert document is initially empty
    type: json_assert
    statements:
      - 'json_equal({{initial_text}}, {"output": ""})'

  - name: Insert Hello from Node 1
    type: call
    node: collab-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: insert_text
    args:
      position: 0
      text: "Hello"

  - name: Wait for text propagation
    type: wait
    seconds: 2

  - name: Get Text from Node 2 (verify sync)
    type: call
    node: collab-near-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: get_text
    outputs:
      synced_text: result

  - name: Assert text synced to Node 2
    type: json_assert
    statements:
      - 'json_equal({{synced_text}}, {"output": "Hello"})'

  - name: Insert World from Node 2
    type: call
    node: collab-near-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key}}"
    method: insert_text
    args:
      position: 5
      text: " World"

  - name: Wait for collaborative edit
    type: wait
    seconds: 2

  - name: Get Final Text from Node 1
    type: call
    node: collab-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_text
    outputs:
      final_text: result

  - name: Assert collaborative editing works
    type: json_assert
    statements:
      - 'json_equal({{final_text}}, {"output": "Hello World"})'

# Configuration options
stop_all_nodes: true
restart: false
wait_timeout: 45
nuke_on_end: true