name: "Blob API - NEAR"
description: "Test the Blob API functionality on NEAR protocol"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: near-blob

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install Blob Application on Node 1
    type: install_application
    node: near-blob-1
    path: "apps/blobs/res/blobs.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Inviter
    type: create_context
    node: near-blob-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Verify Context Creation
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{inviter_key}})"

  # ============================================
  # Multi-Node Setup: Invite & Join Second Node
  # ============================================
  - name: Create Identity on Invitee Node
    type: create_identity
    node: near-blob-2
    outputs:
      invitee_key: publicKey

  - name: Wait for Identity Propagation
    type: wait
    seconds: 2

  - name: Invite Second Node
    type: invite_identity
    node: near-blob-1
    context_id: "{{context_id}}"
    grantee_id: "{{invitee_key}}"
    granter_id: "{{inviter_key}}"
    capability: member
    outputs:
      invitation: invitation

  - name: Join Context from Invitee
    type: join_context
    node: near-blob-2
    context_id: "{{context_id}}"
    invitee_id: "{{invitee_key}}"
    invitation: "{{invitation}}"

  - name: Wait for Context Sync
    type: wait
    seconds: 3

  # ============================================
  # Blob Testing: Upload and verify files
  # ============================================
  - name: Upload PNG to Blob Storage
    type: upload_blob
    node: near-blob-1
    file_path: "apps/blobs/static/sample.png"
    context_id: "{{context_id}}"
    outputs:
      png_blob_id: blob_id
      png_blob_size: size

  - name: Register PNG in Contract
    type: call
    node: near-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: upload_file
    args:
      name: screenshot.png
      blob_id_str: "{{png_blob_id}}"
      size: "{{png_blob_size}}"
      mime_type: image/png
    outputs:
      file_id: result.output

  - name: Verify PNG Upload Response
    type: assert
    statements:
      - "is_set({{file_id}})"

  - name: Wait for Blob Announcement
    type: wait
    seconds: 3

  - name: List Files from Node 2 (verify sync)
    type: call
    node: near-blob-2
    context_id: "{{context_id}}"
    executor_public_key: "{{invitee_key}}"
    method: list_files
    outputs:
      file_list: result

  - name: Verify File List Contains PNG
    type: assert
    statements:
      - "is_set({{file_list}})"

# Configuration options
stop_all_nodes: true
restart: false
wait_timeout: 90
nuke_on_end: true