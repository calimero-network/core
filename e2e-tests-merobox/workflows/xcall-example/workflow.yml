name: "XCall Ping-Pong - NEAR"
description: "Cross-context calls (XCall) using ping-pong between contexts on NEAR"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: xcall-near

steps:
  # ============================================
  # Setup Phase: Install app and create contexts
  # ============================================
  - name: Install XCall Application on Node 1
    type: install_application
    node: xcall-near-1
    path: "apps/xcall-example/res/xcall_example.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context A on Node 1
    type: create_context
    node: xcall-near-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_a_id: contextId
      context_a_member_key: memberPublicKey

  - name: Assert Context A created
    type: assert
    statements:
      - "is_set({{context_a_id}})"
      - "is_set({{context_a_member_key}})"

  - name: Create Context B on Node 1
    type: create_context
    node: xcall-near-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_b_id: contextId
      context_b_member_key: memberPublicKey

  - name: Assert Context B created
    type: assert
    statements:
      - "is_set({{context_b_id}})"
      - "is_set({{context_b_member_key}})"

  # ============================================
  # Identity Phase: Create identities for Node 2
  # ============================================
  - name: Create Identity for Context A on Node 2
    type: create_identity
    node: xcall-near-2
    outputs:
      identity_a: publicKey

  - name: Create Identity for Context B on Node 2
    type: create_identity
    node: xcall-near-2
    outputs:
      identity_b: publicKey

  - name: Wait for identity creation
    type: wait
    seconds: 3

  # ============================================
  # Invitation Phase: Join both contexts
  # ============================================
  - name: Invite Identity A to Context A
    type: invite_identity
    node: xcall-near-1
    context_id: "{{context_a_id}}"
    grantee_id: "{{identity_a}}"
    granter_id: "{{context_a_member_key}}"
    capability: member
    outputs:
      invitation_a: invitation

  - name: Invite Identity B to Context B
    type: invite_identity
    node: xcall-near-1
    context_id: "{{context_b_id}}"
    grantee_id: "{{identity_b}}"
    granter_id: "{{context_b_member_key}}"
    capability: member
    outputs:
      invitation_b: invitation

  - name: Node 2 Join Context A
    type: join_context
    node: xcall-near-2
    context_id: "{{context_a_id}}"
    invitee_id: "{{identity_a}}"
    invitation: "{{invitation_a}}"

  - name: Node 2 Join Context B
    type: join_context
    node: xcall-near-2
    context_id: "{{context_b_id}}"
    invitee_id: "{{identity_b}}"
    invitation: "{{invitation_b}}"

  - name: Wait for context joins
    type: wait
    seconds: 3

  # ============================================
  # Testing Phase: XCall ping-pong functionality
  # ============================================
  - name: Check initial counter on Context A
    type: call
    node: xcall-near-1
    context_id: "{{context_a_id}}"
    executor_public_key: "{{context_a_member_key}}"
    method: get_counter
    outputs:
      context_a_initial: result

  - name: Assert Context A starts with counter at 0
    type: json_assert
    statements:
      - 'json_equal({{context_a_initial}}, {"output": 0})'

  - name: Check initial counter on Context B
    type: call
    node: xcall-near-1
    context_id: "{{context_b_id}}"
    executor_public_key: "{{context_b_member_key}}"
    method: get_counter
    outputs:
      context_b_initial: result

  - name: Assert Context B starts with counter at 0
    type: json_assert
    statements:
      - 'json_equal({{context_b_initial}}, {"output": 0})'

  - name: Ping from Context A to Context B
    type: call
    node: xcall-near-1
    context_id: "{{context_a_id}}"
    executor_public_key: "{{context_a_member_key}}"
    method: ping
    args:
      target_context_id: "{{context_b_id}}"

  - name: Wait for XCall propagation
    type: wait
    seconds: 3

  - name: Check counter after ping on Context B
    type: call
    node: xcall-near-2
    context_id: "{{context_b_id}}"
    executor_public_key: "{{identity_b}}"
    method: get_counter
    outputs:
      context_b_after_ping: result

  - name: Assert Context B counter incremented
    type: json_assert
    statements:
      - 'json_equal({{context_b_after_ping}}, {"output": 1})'

# Configuration options
stop_all_nodes: true
restart: false
wait_timeout: 60
nuke_on_end: true