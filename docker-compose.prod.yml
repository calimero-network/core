x-node-defaults: &node-defaults
  build:
    context: .
    dockerfile: Dockerfile
    target: runtime
    secrets:
      - gh-token
  user: root
  volumes:
    - calimero_auth_node:/calimero
  healthcheck:
    test:
      [
        "CMD-SHELL",
        "curl -f http://localhost:$${NODE_PORT}/admin-api/peers || exit 0",
      ]
    interval: 10s
    timeout: 5s
    retries: 5

services:
  # Primary node
  node:
    <<: *node-defaults
    environment:
      - NODE_NAME=authnode1
      - SWARM_PORT=2428
      - NODE_PORT=2528
      - CALIMERO_HOME=/calimero/data
    ports:
      - "2428:2428"
      - "2528:2528"
    entrypoint: ["/bin/sh", "-c"]
    command: >
      "mkdir -p $${CALIMERO_HOME} $${CALIMERO_HOME}/../logic $${CALIMERO_HOME}/../credentials &&
      if [ ! -d $${CALIMERO_HOME}/config ]; then
        merod --node-name $${NODE_NAME} --home $${CALIMERO_HOME} init --server-host 0.0.0.0 --server-port 2528 --swarm-port 2428
      fi &&
      merod --node-name $${NODE_NAME} --home $${CALIMERO_HOME} run"
    networks:
      - internal
      - web
    labels:
      - "traefik.enable=true"

      # Node1 API routes (protected)
      - "traefik.http.routers.node1-api.rule=Host(`node1.127.0.0.1.nip.io`) && (PathPrefix(`/jsonrpc`) || PathPrefix(`/admin-api/`))"
      - "traefik.http.routers.node1-api.entrypoints=web"
      - "traefik.http.routers.node1-api.service=node1-core"
      - "traefik.http.routers.node1-api.middlewares=cors,auth-node1"

      # Node1 WebSocket (protected)
      - "traefik.http.routers.node1-ws.rule=Host(`node1.127.0.0.1.nip.io`) && PathPrefix(`/ws`)"
      - "traefik.http.routers.node1-ws.entrypoints=web"
      - "traefik.http.routers.node1-ws.service=node1-core"
      - "traefik.http.routers.node1-ws.middlewares=cors,auth-node1"

      # Node1 Admin dashboard (publicly accessible)
      - "traefik.http.routers.node1-dashboard.rule=Host(`node1.127.0.0.1.nip.io`) && PathPrefix(`/admin-dashboard`)"
      - "traefik.http.routers.node1-dashboard.entrypoints=web"
      - "traefik.http.routers.node1-dashboard.service=node1-core"
      - "traefik.http.routers.node1-dashboard.middlewares=cors"

      # Auth service route for node1 subdomain (both /auth/ and /admin/)
      - "traefik.http.routers.node1-auth.rule=Host(`node1.127.0.0.1.nip.io`) && (PathPrefix(`/auth/`) || PathPrefix(`/admin/`))"
      - "traefik.http.routers.node1-auth.entrypoints=web"
      - "traefik.http.routers.node1-auth.service=auth-service"
      - "traefik.http.routers.node1-auth.middlewares=cors,auth-headers"
      - "traefik.http.routers.node1-auth.priority=200"

      # Forward Auth middleware for node1 service
      - "traefik.http.middlewares.auth-node1.forwardauth.address=http://auth:3001/auth/validate"
      - "traefik.http.middlewares.auth-node1.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.auth-node1.forwardauth.authResponseHeaders=X-Auth-User,X-Auth-Permissions"

      # Define the service
      - "traefik.http.services.node1-core.loadbalancer.server.port=2528"

  # Auth service
  auth:
    build:
      context: .
      dockerfile: Dockerfile.auth
      target: runtime
      secrets:
        - gh-token
    user: root
    volumes:
      - calimero_auth_data:/data
    environment:
      - RUST_LOG=debug
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/auth/health"]
      interval: 30s
      timeout: 10s
    networks:
      - internal
      - web
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    labels:
      - "traefik.enable=true"

      # Auth service on localhost (both /auth/ and /admin/)
      - "traefik.http.routers.auth-public.rule=Host(`localhost`) && (PathPrefix(`/auth/`) || PathPrefix(`/admin/`))"
      - "traefik.http.routers.auth-public.entrypoints=web"
      - "traefik.http.routers.auth-public.service=auth-service"
      - "traefik.http.routers.auth-public.middlewares=cors,auth-headers"
      - "traefik.http.routers.auth-public.priority=100"

      # Add Node ID header for auth service
      - "traefik.http.middlewares.auth-headers.headers.customrequestheaders.X-Node-ID=auth"

      # Define the service
      - "traefik.http.services.auth-service.loadbalancer.server.port=3001"

  # Reverse proxy
  proxy:
    image: traefik:v2.10
    command:
      - "--api.insecure=true"
      - "--providers.docker=true"
      - "--entrypoints.web.address=:80"
      - "--accesslog=true"
      - "--log.level=DEBUG"
      - "--providers.docker.exposedByDefault=false"
      - "--providers.docker.network=${COMPOSE_PROJECT_NAME:-calimero}_web"
      - "--serversTransport.forwardingTimeouts.dialTimeout=30s"
      - "--serversTransport.forwardingTimeouts.responseHeaderTimeout=30s"
      - "--serversTransport.forwardingTimeouts.idleConnTimeout=30s"
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - web
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      # Proxy dashboard
      - "traefik.http.routers.proxy-dashboard.rule=Host(`proxy.127.0.0.1.nip.io`)"
      - "traefik.http.routers.proxy-dashboard.entrypoints=web"
      - "traefik.http.routers.proxy-dashboard.service=api@internal"
      
      # Shared middleware definitions
      - "traefik.http.middlewares.cors.headers.accesscontrolallowmethods=GET,OPTIONS,PUT,POST,DELETE"
      - "traefik.http.middlewares.cors.headers.accesscontrolallowheaders=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolalloworiginlist=*"
      - "traefik.http.middlewares.cors.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.cors.headers.addvaryheader=true"
      - "traefik.http.middlewares.cors.headers.accesscontrolexposeheaders=X-Auth-Error"

networks:
  web:
    driver: bridge
  internal:
    internal: true

volumes:
  calimero_auth_node:
    driver: local
  calimero_auth_data:
    driver: local

secrets:
  gh-token:
    environment: GH_TOKEN
