# ============================================================================
# Benchmark: Warm Connection Dial Latency
# ============================================================================
#
# Tests dial latency when connections are already established (back-to-back syncs)
# Expected: Dial should be fast (<50ms) due to connection reuse
#
# Run with:
#   merobox bootstrap run --no-docker --binary-path ./target/release/merod \
#     --e2e-mode workflows/sync/bench-dial-warm.yml
#
# ============================================================================

description: "2 nodes, warm connection dial latency test"
name: "Bench Dial Warm"

force_pull_image: false
nuke_on_start: true
e2e_mode: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: dial

steps:
  # ===========================================================================
  # PHASE 1: Setup
  # ===========================================================================

  - name: Install Application on Node 1
    type: install_application
    node: dial-1
    path: ./workflow-examples/res/kv_store.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: dial-1
    application_id: "{{app_id}}"
    outputs:
      context_id: contextId
      pk_node1: memberPublicKey

  - name: Create Identity on Node 2
    type: create_identity
    node: dial-2
    outputs:
      pk_node2: publicKey

  - name: Invite Node 2 to Context
    type: invite_identity
    node: dial-1
    context_id: "{{context_id}}"
    grantee_id: "{{pk_node2}}"
    granter_id: "{{pk_node1}}"
    capability: member
    outputs:
      invitation_node2: invitation

  - name: Node 2 Joins Context
    type: join_context
    node: dial-2
    context_id: "{{context_id}}"
    invitee_id: "{{pk_node2}}"
    invitation: "{{invitation_node2}}"

  - name: Wait for mesh formation
    type: wait
    seconds: 10

  # ===========================================================================
  # PHASE 2: Warm up connection with initial write
  # ===========================================================================

  - name: Write warmup key
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: warmup1
      value: value1

  - name: Wait for sync
    type: wait
    seconds: 5

  # ===========================================================================
  # PHASE 3: Back-to-back writes to test warm connection reuse
  # ===========================================================================

  - name: Rapid write 1
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: rapid1
      value: value1

  - name: Short wait 1
    type: wait
    seconds: 1

  - name: Rapid write 2
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: rapid2
      value: value2

  - name: Short wait 2
    type: wait
    seconds: 1

  - name: Rapid write 3
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: rapid3
      value: value3

  - name: Short wait 3
    type: wait
    seconds: 1

  - name: Rapid write 4
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: rapid4
      value: value4

  - name: Short wait 4
    type: wait
    seconds: 1

  - name: Rapid write 5
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node1}}"
    method: set
    args:
      key: rapid5
      value: value5

  - name: Wait for sync convergence
    type: wait
    seconds: 10

  # ===========================================================================
  # PHASE 4: Verification
  # ===========================================================================

  - name: Verify rapid5 on Node 2
    type: call
    node: dial-2
    context_id: "{{context_id}}"
    executor_public_key: "{{pk_node2}}"
    method: get
    args:
      key: rapid5

  - name: Final wait for log flush
    type: wait
    seconds: 2
