# Benchmark: Cold Connection Dial Latency
# Tests dial latency after node restart (new connections required)
# Expected: Dial should be slower (~150-200ms) as new connections established

name: bench-dial-cold
nodes: 2
dev_mode: true

merod_args: "--state-sync-strategy hash-comparison"

steps:
  - name: Install Application on Node 1
    type: install_application
    node: dial-1
    path: ./workflow-examples/res/kv_store.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: dial-1
    application_id: "{{app_id}}"
    outputs:
      context_id: contextId
      pk_node1: memberPublicKey

  - name: Get Node 2 identity
    type: get_node_identity
    node: dial-2
    outputs:
      pk_node2: publicKey

  - name: Invite Node 2 to Context
    type: invite_node
    node: dial-1
    context_id: "{{context_id}}"
    inviter_pk: "{{pk_node1}}"
    invitee_pk: "{{pk_node2}}"

  - name: Join Context on Node 2
    type: join_context
    node: dial-2
    context_id: "{{context_id}}"

  - name: Wait for mesh formation
    type: sleep
    duration_ms: 3000

  # Write baseline data
  - name: Write baseline key
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    method: set
    args_json: '{"key": "baseline", "value": "initial"}'

  - name: Wait for sync
    type: sleep
    duration_ms: 3000

  # Stop Node 2 to break connections
  - name: Stop Node 2
    type: stop_node
    node: dial-2

  - name: Wait for connections to close
    type: sleep
    duration_ms: 2000

  # Write while Node 2 is down
  - name: Write key while N2 down
    type: call
    node: dial-1
    context_id: "{{context_id}}"
    method: set
    args_json: '{"key": "cold1", "value": "written_while_down"}'

  # Restart Node 2 - will need cold dial
  - name: Start Node 2
    type: start_node
    node: dial-2

  - name: Wait for restart and cold dial
    type: sleep
    duration_ms: 15000

  # Verify cold dial synced the data
  - name: Verify cold1 synced
    type: call
    node: dial-2
    context_id: "{{context_id}}"
    method: entries
    expected_result:
      contains:
        - key: cold1
          value: written_while_down

  - name: Final wait for log flush
    type: sleep
    duration_ms: 1000
