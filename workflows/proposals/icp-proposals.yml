name: "Proposals - ICP"
description: "Test proposal functionality on ICP protocol"

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: icp-prop

steps:
  - name: Install Proposals Application on Node 1
    type: install_application
    node: icp-prop-1
    url: "https://github.com/calimero-network/demo-blockchain-integrations/raw/refs/heads/master/logic/res/blockchain.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Mesh
    type: create_mesh
    context_node: icp-prop-1
    application_id: "{{app_id}}"
    protocol: icp
    nodes:
      - icp-prop-2
    capability: member
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Wait for mesh formation and sync
    type: wait
    seconds: 10

  - name: Create SetActiveProposalsLimit Proposal from Node 1
    type: call
    node: icp-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: create_new_proposal
    args:
      request:
        action_type: SetActiveProposalsLimit
        params:
          active_proposals_limit: 10
    outputs:
      proposal_id: result.output

  - name: Assert proposal created
    type: assert
    statements:
      - "is_set({{proposal_id}})"

  - name: Wait for proposal propagation
    type: wait
    seconds: 3

  - name: Approve Proposal from Node 2
    type: call
    node: icp-prop-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_icp-prop-2}}"
    method: approve_proposal
    args:
      proposal_id: "{{proposal_id}}"

  - name: Wait for approval propagation
    type: wait
    seconds: 3

  - name: Send Message to Proposal from Node 1
    type: call
    node: icp-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: send_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
      message:
        id: msg-1
        author: Node 1
        text: "Proposal looks good!"
        created_at: "2024-01-01T00:00:00Z"

  - name: Wait for message propagation
    type: wait
    seconds: 3

  - name: Send Message from Node 2
    type: call
    node: icp-prop-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_icp-prop-2}}"
    method: send_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
      message:
        id: msg-2
        author: Node 2
        text: "Agreed!"
        created_at: "2024-01-01T00:01:00Z"

  - name: Wait for sync
    type: wait
    seconds: 3

  - name: Get Proposal Messages from Node 1
    type: call
    node: icp-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: get_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
    outputs:
      messages_node1: result.output

  - name: Assert messages synced to Node 1
    type: assert
    statements:
      - "is_set({{messages_node1}})"

# Configuration options
stop_all_nodes: false
restart: false
wait_timeout: 45
