name: "Proposals - NEAR"
description: "Test proposal functionality on NEAR protocol"

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: near-prop

steps:
  - name: Install Proposals Application on Node 1
    type: install_application
    node: near-prop-1
    path: ../../apps/demo-blockchain-integrations/res/blockchain.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Mesh
    type: create_mesh
    context_node: near-prop-1
    application_id: "{{app_id}}"
    protocol: near
    nodes:
      - near-prop-2
    capability: member
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Wait for mesh formation and sync
    type: wait
    seconds: 10

  - name: Create SetContextValue Proposal from Node 1
    type: call
    node: near-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: create_new_proposal
    args:
      request:
        action_type: SetContextValue
        params:
          key: "test_key"
          value: "test_value"
    outputs:
      proposal_id: result.output

  - name: Assert proposal created
    type: assert
    statements:
      - "is_set({{proposal_id}})"

  - name: Wait for proposal propagation
    type: wait
    seconds: 3

  - name: Approve Proposal from Node 2
    type: call
    node: near-prop-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_near-prop-2}}"
    method: approve_proposal
    args:
      proposal_id: "{{proposal_id}}"

  - name: Wait for approval propagation
    type: wait
    seconds: 3

  - name: Send Message to Proposal from Node 1
    type: call
    node: near-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: send_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
      message:
        id: msg-1
        author: Node 1
        text: "Proposal looks good!"
        created_at: "2024-01-01T00:00:00Z"

  - name: Wait for message propagation
    type: wait
    seconds: 3

  - name: Send Message from Node 2
    type: call
    node: near-prop-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_near-prop-2}}"
    method: send_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
      message:
        id: msg-2
        author: Node 2
        text: "Agreed!"
        created_at: "2024-01-01T00:01:00Z"

  - name: Wait for sync
    type: wait
    seconds: 3

  - name: Get Proposal Messages from Node 1
    type: call
    node: near-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: get_proposal_messages
    args:
      proposal_id: "{{proposal_id}}"
    outputs:
      messages_node1: result.output

  - name: Assert messages synced to Node 1
    type: assert
    statements:
      - "is_set({{messages_node1}})"

# Configuration options
stop_all_nodes: false
restart: false
wait_timeout: 45
