name: "Proposals - Ethereum"
description: "Test proposal functionality on Ethereum protocol"

# Test configuration
no_docker: true

nodes:
  chain_id: calimero-testnet
  count: 3
  image: ghcr.io/calimero-network/merod:edge
  prefix: eth-prop

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install Proposals Application on Node 1
    type: install_application
    node: eth-prop-1
    url: "https://github.com/calimero-network/demo-blockchain-integrations/raw/refs/heads/master/logic/res/blockchain.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: eth-prop-1
    application_id: "{{app_id}}"
    protocol: ethereum
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{inviter_key}})"

  # ============================================
  # Identity Phase: Create identities
  # ============================================
  - name: Create Identity on Node 2
    type: create_identity
    node: eth-prop-2
    outputs:
      invitee2_key: publicKey

  - name: Create Identity on Node 3
    type: create_identity
    node: eth-prop-3
    outputs:
      invitee3_key: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 2

  # ============================================
  # Invitation Phase: Invite and join
  # ============================================
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: eth-prop-1
    context_id: "{{context_id}}"
    grantee_id: "{{invitee2_key}}"
    granter_id: "{{inviter_key}}"
    capability: member
    outputs:
      invitation2: invitation

  - name: Join Context from Node 2
    type: join_context
    node: eth-prop-2
    context_id: "{{context_id}}"
    invitee_id: "{{invitee2_key}}"
    invitation: "{{invitation2}}"

  - name: Invite Node 3 from Node 1
    type: invite_identity
    node: eth-prop-1
    context_id: "{{context_id}}"
    grantee_id: "{{invitee3_key}}"
    granter_id: "{{inviter_key}}"
    capability: member
    outputs:
      invitation3: invitation

  - name: Join Context from Node 3
    type: join_context
    node: eth-prop-3
    context_id: "{{context_id}}"
    invitee_id: "{{invitee3_key}}"
    invitation: "{{invitation3}}"

  - name: Wait for Consensus After Join
    type: wait
    seconds: 2

  # ============================================
  # Testing Phase: Create and vote on proposals
  # ============================================
  - name: Create Proposal from Node 1
    type: call
    node: eth-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: create_proposal
    args:
      title: "Test Proposal"
      description: "A test proposal for voting"
    outputs:
      proposal_id: result

  - name: Assert proposal created
    type: assert
    statements:
      - "is_set({{proposal_id}})"

  - name: Wait for proposal propagation
    type: wait
    seconds: 2

  - name: Vote Yes from Node 2
    type: call
    node: eth-prop-2
    context_id: "{{context_id}}"
    executor_public_key: "{{invitee2_key}}"
    method: vote
    args:
      proposal_id: "{{proposal_id}}"
      vote: true

  - name: Vote Yes from Node 3
    type: call
    node: eth-prop-3
    context_id: "{{context_id}}"
    executor_public_key: "{{invitee3_key}}"
    method: vote
    args:
      proposal_id: "{{proposal_id}}"
      vote: true

  - name: Wait for vote propagation
    type: wait
    seconds: 2

  - name: Get Proposal Status
    type: call
    node: eth-prop-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: get_proposal
    args:
      proposal_id: "{{proposal_id}}"
    outputs:
      proposal_status: result

  - name: Assert proposal has votes
    type: assert
    statements:
      - "is_set({{proposal_status}})"

# Configuration options
no_docker: true
stop_all_nodes: true
restart: false
wait_timeout: 45
