<!-- NEAR Wallet Provider Template -->

<!-- Provider Script (to be included in PROVIDER_SCRIPTS) -->
<script id="near-wallet-script">
    // Load NEAR API JS and directly integrate with MyNearWallet
    (function loadScripts() {
        // Load NEAR API JS
        const script = document.createElement('script');
        script.src = "https://cdn.jsdelivr.net/npm/near-api-js@1.1.0/dist/near-api-js.min.js";
        script.onload = function() {
            console.log("NEAR API JS loaded successfully");
            window.nearScriptsLoaded = true;
            // Trigger an event that scripts are loaded
            document.dispatchEvent(new Event('nearScriptsLoaded'));
        };
        script.onerror = function(e) {
            console.error("Failed to load NEAR API JS", e);
        };
        document.head.appendChild(script);
    })();
</script>

<!-- Provider Button (to be included in PROVIDER_BUTTONS) -->
<button id="near-login" class="auth-button near-button">
    Connect with NEAR Wallet
</button>
<div id="near-result" class="result"></div>

<!-- Provider Initialization (to be included in PROVIDER_INIT) -->
<script id="near-wallet-init">
    // NEAR wallet initialization
    function initializeNearWallet() {
        const nearLogin = document.getElementById('near-login');
        const nearResult = document.getElementById('near-result');
        
        // Only initialize if the elements exist
        if (!nearLogin || !nearResult) return;
        
        // Set initial button state to loading
        nearLogin.textContent = "Loading NEAR Wallet...";
        nearLogin.disabled = true;
        
        // Initialize NEAR connection
        async function initNear() {
            try {
                console.log("Setting up NEAR connection...");
                
                // Check if NEAR API is available
                if (!window.nearApi) {
                    throw new Error("NEAR API not loaded properly");
                }
                
                // Configure NEAR connection
                const nearConfig = {
                    networkId: "{{NEAR_NETWORK}}",
                    nodeUrl: "https://rpc.{{NEAR_NETWORK}}.near.org",
                    walletUrl: "https://{{NEAR_NETWORK}}.mynearwallet.com",
                    helperUrl: "https://helper.{{NEAR_NETWORK}}.near.org",
                    explorerUrl: "https://explorer.{{NEAR_NETWORK}}.near.org",
                };
                
                // Initialize connection
                const near = await window.nearApi.connect(nearConfig);
                const wallet = new window.nearApi.WalletConnection(near, "calimero-auth");
                
                // Check if already signed in
                if (wallet.isSignedIn()) {
                    const accountId = wallet.getAccountId();
                    nearLogin.textContent = "Sign Message with NEAR";
                    nearResult.textContent = `Connected as: ${accountId}`;
                    nearResult.style.display = "block";
                    
                    // Add click event to sign message
                    nearLogin.addEventListener('click', () => signMessage(wallet));
                } else {
                    nearLogin.textContent = "Connect with NEAR Wallet";
                    
                    // Add click event to sign in
                    nearLogin.addEventListener('click', () => {
                        wallet.requestSignIn({
                            contractId: "",
                            successUrl: window.location.href,
                            failureUrl: window.location.href
                        });
                    });
                }
                
                // Enable button
                nearLogin.disabled = false;
                
                console.log("NEAR connection setup complete");
                return true;
            } catch (error) {
                console.error("Error initializing NEAR connection:", error);
                nearLogin.textContent = "NEAR Wallet Error";
                nearResult.textContent = "Error: " + error.message;
                nearResult.style.display = "block";
                nearLogin.disabled = true;
                return false;
            }
        }
        
        // Sign a message with the wallet
        async function signMessage(wallet) {
            try {
                if (!wallet || !wallet.isSignedIn()) {
                    throw new Error("Not signed in");
                }
                
                const accountId = wallet.getAccountId();
                
                // Create a message including a timestamp to prevent replay attacks
                const timestamp = Date.now();
                const message = `Authenticate with Calimero: ${timestamp}`;
                
                // Use the NEAR API to get access to keys
                const keyPair = await wallet._keyStore.getKey(wallet._networkId, accountId);
                if (!keyPair) {
                    throw new Error("No key pair available for signing");
                }
                
                // Sign the message
                const msgBytes = new TextEncoder().encode(message);
                const signature = keyPair.sign(msgBytes);
                const publicKey = keyPair.getPublicKey().toString();
                
                // Convert signature to base64
                const signatureBase64 = Buffer.from(signature.signature).toString('base64');
                
                // Show the result
                nearResult.textContent = "Signed message. Authenticating...";
                nearResult.style.display = "block";
                
                // Send the authentication data to the server
                const response = await fetch('/api/auth/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-near-account-id': accountId,
                        'x-near-public-key': publicKey,
                        'x-near-signature': signatureBase64,
                        'x-near-message': message
                    },
                    body: JSON.stringify({
                        auth_method: 'near_wallet',
                        account_id: accountId,
                        public_key: publicKey,
                        signature: signatureBase64,
                        message: message,
                        timestamp: timestamp
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    nearResult.textContent = "Authentication successful!";
                    
                    // If there's a redirect URL in the query params, redirect there
                    const urlParams = new URLSearchParams(window.location.search);
                    const redirectUrl = urlParams.get('redirect_url');
                    if (redirectUrl) {
                        window.location.href = redirectUrl;
                    }
                } else {
                    const error = await response.text();
                    nearResult.textContent = "Authentication failed: " + error;
                }
            } catch (error) {
                console.error("Signing error:", error);
                nearResult.textContent = "Error signing message: " + error.message;
                nearResult.style.display = "block";
            }
        }
        
        // Wait for scripts to load before initializing
        function checkAndInitialize() {
            console.log("Checking if NEAR scripts are loaded...");
            
            // If scripts are already loaded, initialize immediately
            if (window.nearScriptsLoaded) {
                console.log("NEAR scripts already loaded, initializing now");
                initNear();
                return;
            }
            
            // Set a timeout in case scripts take too long to load
            const timeout = setTimeout(() => {
                console.error("Timeout waiting for NEAR scripts to load");
                nearLogin.textContent = "NEAR Wallet Not Available";
                nearLogin.disabled = true;
            }, 15000); // 15 seconds timeout
            
            // Listen for the scripts loaded event
            document.addEventListener('nearScriptsLoaded', function() {
                clearTimeout(timeout);
                console.log("Received nearScriptsLoaded event, initializing connection");
                // Give it a small delay to ensure everything is initialized
                setTimeout(initNear, 500);
            });
        }
        
        // Start the initialization process
        checkAndInitialize();
    }
    
    // Add the NEAR wallet initialization to the global initialization
    if (typeof initializeProviders !== 'function') {
        window.initializeProviders = initializeNearWallet;
    } else {
        const originalInit = window.initializeProviders;
        window.initializeProviders = function() {
            originalInit();
            initializeNearWallet();
        };
    }
</script> 