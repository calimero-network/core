name: Collections Benchmark - Rust SDK
description: Throughput testing for CRDT collections using single-operation methods

force_pull_image: true

nodes:
  chain_id: testnet-1
  count: 1
  image: ghcr.io/calimero-network/merod:edge
  prefix: benchmark-node

steps:
  # SETUP

  - name: Install Benchmark Application
    type: install_application
    node: benchmark-node-1
    path: res/collections_benchmark_rust.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context
    type: create_context
    node: benchmark-node-1
    application_id: "{{app_id}}"
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # MAP BENCHMARKS

  - name: Get Initial Operation Count (Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      map_initial_count: result

  - name: Map Insert Throughput Test (100 ops)
    type: repeat
    count: 100
    outputs:
      iteration: iteration
      map_insert_duration: duration_seconds
      map_insert_throughput: throughput_ops_per_sec
      map_insert_avg_latency: avg_time_per_op_ms
    steps:
      - name: Map Insert
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: map_insert
        args:
          key: "map_key_{{iteration}}"
        outputs:
          map_insert_result: result

  - name: Get Final Operation Count (Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      map_final_count: result

  - name: Map Get Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      map_get_duration: duration_seconds
      map_get_throughput: throughput_ops_per_sec
      map_get_avg_latency: avg_time_per_op_ms
    steps:
      - name: Map Get
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: map_get
        args:
          key: "map_key_{{iteration}}"

  # NESTED MAP BENCHMARKS (Level 2)

  - name: Get Initial Operation Count (Nested Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      nested_map_initial_count: result

  - name: Nested Map Insert Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      nested_map_insert_duration: duration_seconds
      nested_map_insert_throughput: throughput_ops_per_sec
      nested_map_insert_avg_latency: avg_time_per_op_ms
    steps:
      - name: Nested Map Insert
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: nested_map_insert
        args:
          outer_key: "outer_{{iteration}}"
          inner_key: "inner_{{iteration}}"
        outputs:
          nested_map_insert_result: result

  - name: Get Final Operation Count (Nested Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      nested_map_final_count: result

  - name: Nested Map Get Throughput Test (25 ops)
    type: repeat
    count: 25
    outputs:
      iteration: iteration
      nested_map_get_duration: duration_seconds
      nested_map_get_throughput: throughput_ops_per_sec
      nested_map_get_avg_latency: avg_time_per_op_ms
    steps:
      - name: Nested Map Get
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: nested_map_get
        args:
          outer_key: "outer_{{iteration}}"
          inner_key: "inner_{{iteration}}"

  # DEEP NESTED MAP BENCHMARKS (Level 3)

  - name: Get Initial Operation Count (Deep Nested Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      deep_nested_map_initial_count: result

  - name: Deep Nested Map Insert Throughput Test (30 ops)
    type: repeat
    count: 30
    outputs:
      iteration: iteration
      deep_nested_map_insert_duration: duration_seconds
      deep_nested_map_insert_throughput: throughput_ops_per_sec
      deep_nested_map_insert_avg_latency: avg_time_per_op_ms
    steps:
      - name: Deep Nested Map Insert
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: deep_nested_map_insert
        args:
          key1: "l1_{{iteration}}"
          key2: "l2_{{iteration}}"
          key3: "l3_{{iteration}}"
        outputs:
          deep_nested_map_insert_result: result

  - name: Get Final Operation Count (Deep Nested Map)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      deep_nested_map_final_count: result

  - name: Deep Nested Map Get Throughput Test (15 ops)
    type: repeat
    count: 15
    outputs:
      iteration: iteration
      deep_nested_map_get_duration: duration_seconds
      deep_nested_map_get_throughput: throughput_ops_per_sec
      deep_nested_map_get_avg_latency: avg_time_per_op_ms
    steps:
      - name: Deep Nested Map Get
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: deep_nested_map_get
        args:
          key1: "l1_{{iteration}}"
          key2: "l2_{{iteration}}"
          key3: "l3_{{iteration}}"

  # VECTOR BENCHMARKS

  - name: Get Initial Operation Count (Vector)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      vector_initial_count: result

  - name: Vector Push Throughput Test (100 ops)
    type: repeat
    count: 100
    outputs:
      iteration: iteration
      vector_push_duration: duration_seconds
      vector_push_throughput: throughput_ops_per_sec
      vector_push_avg_latency: avg_time_per_op_ms
    steps:
      - name: Vector Push
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: vector_push
        outputs:
          vector_push_result: result

  - name: Get Final Operation Count (Vector)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      vector_final_count: result

  - name: Vector Get Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      vector_get_duration: duration_seconds
      vector_get_throughput: throughput_ops_per_sec
      vector_get_avg_latency: avg_time_per_op_ms
    steps:
      - name: Vector Get
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: vector_get
        args:
          index: "{{iteration}}"

  # SET BENCHMARKS

  - name: Get Initial Operation Count (Set)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      set_initial_count: result

  - name: Set Insert Throughput Test (100 ops)
    type: repeat
    count: 100
    outputs:
      iteration: iteration
      set_insert_duration: duration_seconds
      set_insert_throughput: throughput_ops_per_sec
      set_insert_avg_latency: avg_time_per_op_ms
    steps:
      - name: Set Insert
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: set_insert
        args:
          value: "set_value_{{iteration}}"
        outputs:
          set_insert_result: result

  - name: Get Final Operation Count (Set)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      set_final_count: result

  - name: Set Contains Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      set_contains_duration: duration_seconds
      set_contains_throughput: throughput_ops_per_sec
      set_contains_avg_latency: avg_time_per_op_ms
    steps:
      - name: Set Contains
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: set_contains
        args:
          value: "set_value_{{iteration}}"

  # REGISTER BENCHMARKS

  - name: Get Initial Operation Count (Register)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      register_initial_count: result

  - name: Register Set Throughput Test (100 ops)
    type: repeat
    count: 100
    outputs:
      iteration: iteration
      register_set_duration: duration_seconds
      register_set_throughput: throughput_ops_per_sec
      register_set_avg_latency: avg_time_per_op_ms
    steps:
      - name: Register Set
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: register_set
        args:
          key: "register_key_{{iteration}}"
          value: "register_value_{{iteration}}"
        outputs:
          register_set_result: result

  - name: Get Final Operation Count (Register)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      register_final_count: result

  - name: Register Get Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      register_get_duration: duration_seconds
      register_get_throughput: throughput_ops_per_sec
      register_get_avg_latency: avg_time_per_op_ms
    steps:
      - name: Register Get
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: register_get
        args:
          key: "register_key_{{iteration}}"

  # RGA BENCHMARKS

  - name: Get Initial Operation Count (RGA)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      rga_initial_count: result

  - name: RGA Insert Throughput Test (50 ops)
    type: repeat
    count: 50
    outputs:
      iteration: iteration
      rga_insert_duration: duration_seconds
      rga_insert_throughput: throughput_ops_per_sec
      rga_insert_avg_latency: avg_time_per_op_ms
    steps:
      - name: RGA Insert
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: rga_insert
        args:
          index: 0
          text: "a"
        outputs:
          rga_insert_result: result

  - name: Get Final Operation Count (RGA)
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      rga_final_count: result

  - name: RGA Get Text Throughput Test (10 ops)
    type: repeat
    count: 10
    outputs:
      iteration: iteration
      rga_get_text_duration: duration_seconds
      rga_get_text_throughput: throughput_ops_per_sec
      rga_get_text_avg_latency: avg_time_per_op_ms
    steps:
      - name: RGA Get Text
        type: call
        node: benchmark-node-1
        context_id: "{{context_id}}"
        executor_public_key: "{{member_public_key}}"
        method: rga_get_text

  # GENERATE BENCHMARK REPORT

  - name: Generate Benchmark Timing Report
    type: script
    target: local
    description: Generate formatted benchmark timing report
    script: ./scripts/generate-benchmark-report.sh
    args:
      - "--output-file"
      - "./collections-benchmark-report.txt"

  # VERIFY RESULTS

  - name: Get Final Operation Count
    type: call
    node: benchmark-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_operation_count
    outputs:
      final_operation_count: result

  - name: Assert Benchmarks Completed
    type: assert
    statements:
      - "is_set({{final_operation_count}})"
      - "is_set({{map_final_count}})"
      - "is_set({{nested_map_final_count}})"
      - "is_set({{deep_nested_map_final_count}})"
      - "is_set({{vector_final_count}})"
      - "is_set({{set_final_count}})"
      - "is_set({{register_final_count}})"
      - "is_set({{rga_final_count}})"
      - "is_set({{map_insert_throughput}})"
      - "is_set({{map_get_throughput}})"
      - "is_set({{vector_push_throughput}})"
      - "is_set({{set_insert_throughput}})"

stop_all_nodes: true
restart: true
wait_timeout: 300
