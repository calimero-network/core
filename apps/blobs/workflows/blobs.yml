name: Blobs Rust Example
description: Upload, announce, discover and delete blobs using the Rust SDK example.

force_pull_image: true

nodes:
  chain_id: calimero-testnet
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: rust-blob

steps:
  - name: Install Rust blobs app on inviter
    type: install_application
    node: rust-blob-1
    path: "res/blobs.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Mesh
    type: create_mesh
    context_node: rust-blob-1
    application_id: "{{app_id}}"
    nodes:
      - rust-blob-2
    capability: member
    outputs:
      context_id: contextId
      inviter_key: memberPublicKey

  - name: Upload sample PNG blob
    type: upload_blob
    node: rust-blob-1
    file_path: static/sample.png
    context_id: "{{context_id}}"
    outputs:
      png_blob_id: blob_id
      png_blob_size: size

  - name: Register PNG metadata
    type: call
    node: rust-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: upload_file
    args:
      name: screenshot.png
      blob_id_str: "{{png_blob_id}}"
      size: "{{png_blob_size}}"
      mime_type: image/png
    outputs:
      png_file_id: result.output

  - name: Assert PNG registered
    type: assert
    statements:
      - "is_set({{png_file_id}})"

  - name: Upload sample TXT blob
    type: upload_blob
    node: rust-blob-1
    file_path: static/test.txt
    context_id: "{{context_id}}"
    outputs:
      txt_blob_id: blob_id
      txt_blob_size: size

  - name: Register TXT metadata
    type: call
    node: rust-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: upload_file
    args:
      name: readme.txt
      blob_id_str: "{{txt_blob_id}}"
      size: "{{txt_blob_size}}"
      mime_type: text/plain
    outputs:
      txt_file_id: result.output

  - name: Assert TXT registered
    type: assert
    statements:
      - "is_set({{txt_file_id}})"

  - name: Wait for announcements
    type: wait
    seconds: 6

  - name: List files on inviter
    type: call
    node: rust-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: list_files
    outputs:
      inviter_files: result.output

  - name: Assert inviter sees two files
    type: assert
    statements:
      - "contains({{inviter_files}}, '{{png_file_id}}')"
      - "contains({{inviter_files}}, '{{txt_file_id}}')"

  - name: List files on invitee
    type: call
    node: rust-blob-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-blob-2}}"
    method: list_files
    outputs:
      invitee_files: result.output

  - name: Assert invitee sees two files
    type: assert
    statements:
      - "contains({{invitee_files}}, '{{png_file_id}}')"
      - "contains({{invitee_files}}, '{{txt_file_id}}')"

  - name: Get PNG file blob id
    type: call
    node: rust-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: get_blob_id_b58
    args:
      file_id: "{{png_file_id}}"
    outputs:
      retrieved_png_blob: result.output

  - name: Assert PNG blob id matches
    type: assert
    statements:
      - "equal({{retrieved_png_blob}}, {{png_blob_id}})"

  - name: Delete PNG file
    type: call
    node: rust-blob-1
    context_id: "{{context_id}}"
    executor_public_key: "{{inviter_key}}"
    method: delete_file
    args:
      file_id: "{{png_file_id}}"

  - name: Wait for delete propagation
    type: wait
    seconds: 6

  - name: List files after delete
    type: call
    node: rust-blob-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-blob-2}}"
    method: list_files
    outputs:
      final_files: result.output

  - name: Assert only one file remains
    type: assert
    statements:
      - "contains({{final_files}}, '{{txt_file_id}}')"
      - "not_contains({{final_files}}, '{{png_file_id}}')"

stop_all_nodes: false
restart: false
wait_timeout: 120
