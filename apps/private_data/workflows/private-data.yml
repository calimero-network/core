name: Private Data Rust Example
description: Private data storage example using the Rust SDK.

force_pull_image: true

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: rust-private-data

steps:
  - name: Install Private Data Application
    type: install_application
    node: rust-private-data-1
    path: res/private_data.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Mesh
    type: create_mesh
    context_node: rust-private-data-1
    application_id: "{{app_id}}"
    nodes:
      - rust-private-data-2
    capability: member
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Node 1 Add Secret
    type: call
    node: rust-private-data-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: add_secret
    args:
      game_id: game1
      secret: node1-secret-123

  - name: Node 1 Add Another Secret
    type: call
    node: rust-private-data-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: add_secret
    args:
      game_id: game2
      secret: node1-secret-456

  - name: Wait After Node 1 Updates
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - rust-private-data-1
      - rust-private-data-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  - name: Node 1 Get Own Secrets
    type: call
    node: rust-private-data-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: my_secrets
    outputs:
      node_1_secrets: result.output

  - name: Assert Node 1 Has Secrets
    type: assert
    statements:
      - "is_set({{node_1_secrets}})"

  - name: Node 1 Get Games
    type: call
    node: rust-private-data-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: games
    outputs:
      node_1_games: result.output

  - name: Assert Games Are Visible
    type: assert
    statements:
      - "is_set({{node_1_games}})"

  - name: Wait Before Node 2 Read
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - rust-private-data-1
      - rust-private-data-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  - name: Node 2 Get Games
    type: call
    node: rust-private-data-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-private-data-2}}"
    method: games
    outputs:
      node_2_games: result.output

  - name: Assert Node 2 Sees Games
    type: assert
    statements:
      - "is_set({{node_2_games}})"

  - name: Node 2 Get Own Secrets
    type: call
    node: rust-private-data-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-private-data-2}}"
    method: my_secrets
    outputs:
      node_2_secrets: result.output

  - name: Assert Node 2 Has No Secrets Initially
    type: assert
    statements:
      - "is_empty({{node_2_secrets}})"

  - name: Node 2 Add Secret
    type: call
    node: rust-private-data-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-private-data-2}}"
    method: add_secret
    args:
      game_id: game3
      secret: node2-secret-789

  - name: Wait After Node 2 Update
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - rust-private-data-1
      - rust-private-data-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  - name: Node 1 Get Own Secrets Again
    type: call
    node: rust-private-data-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: my_secrets
    outputs:
      node_1_secrets_again: result.output

  - name: Assert Node 1 Secrets Unchanged
    type: assert
    statements:
      - "is_set({{node_1_secrets_again}})"

  - name: Node 2 Try To Guess
    type: call
    node: rust-private-data-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_rust-private-data-2}}"
    method: add_guess
    args:
      game_id: game1
      guess: wrong-guess
    outputs:
      guess_result: result.output

  - name: Assert Guess Failed
    type: assert
    statements:
      - "{{guess_result}} == False"

stop_all_nodes: false
restart: false
wait_timeout: 120
