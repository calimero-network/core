name: Simple Sync Test (No Handlers)
description: Basic set/get sync test without event handlers

force_pull_image: false

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: e2e-node

steps:
  - name: Install application on node-1
    type: install_application
    node: e2e-node-1
    path: res/e2e_kv_store.wasm
    dev: true
    outputs:
      app_id: applicationId

  - name: Create mesh with node-2
    type: create_mesh
    context_node: e2e-node-1
    application_id: "{{app_id}}"
    nodes:
      - e2e-node-2
    capability: member
    outputs:
      context_id: contextId
      node1_key: memberPublicKey

  # Simple set on node-1
  - name: Set value on node-1
    type: call
    node: e2e-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{node1_key}}"
    method: set
    args:
      key: "test_key"
      value: "test_value"

  - name: Wait for sync
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - e2e-node-1
      - e2e-node-2
    timeout: 30
    check_interval: 2
    trigger_sync: true

  # Verify on node-2
  - name: Get value on node-2
    type: call
    node: e2e-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_e2e-node-2}}"
    method: get
    args:
      key: "test_key"
    outputs:
      result: result

  - name: Assert value synced
    type: json_assert
    statements:
      - 'json_equal({{result}}, {"output": "test_value"})'

  # Now node-2 writes
  - name: Set value on node-2
    type: call
    node: e2e-node-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_e2e-node-2}}"
    method: set
    args:
      key: "from_node2"
      value: "node2_value"

  - name: Wait for sync after node-2
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - e2e-node-1
      - e2e-node-2
    timeout: 30
    check_interval: 2
    trigger_sync: true

  # Verify on node-1
  - name: Get node-2 value on node-1
    type: call
    node: e2e-node-1
    context_id: "{{context_id}}"
    executor_public_key: "{{node1_key}}"
    method: get
    args:
      key: "from_node2"
    outputs:
      result2: result

  - name: Assert node-2 value synced to node-1
    type: json_assert
    statements:
      - 'json_equal({{result2}}, {"output": "node2_value"})'
