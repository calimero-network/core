name: "KV Store - ICP"
description: "Basic KV Store test on ICP protocol"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 3
  image: ghcr.io/calimero-network/merod:edge
  prefix: kv-icp

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install KV Store Application on Node 1
    type: install_application
    node: kv-icp-1
    path: "apps/kv-store/res/kv_store.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: kv-icp-1
    application_id: "{{app_id}}"
    protocol: icp
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{member_public_key}})"

  # ============================================
  # Identity Phase: Create identities for nodes
  # ============================================
  - name: Create Identity on Node 2
    type: create_identity
    node: kv-icp-2
    outputs:
      public_key_2: publicKey

  - name: Create Identity on Node 3
    type: create_identity
    node: kv-icp-3
    outputs:
      public_key_3: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 2

  # ============================================
  # Invitation Phase: Invite and join nodes
  # ============================================
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: kv-icp-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key_2}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation_2: invitation

  - name: Join Context from Node 2
    type: join_context
    node: kv-icp-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key_2}}"
    invitation: "{{invitation_2}}"

  - name: Invite Node 3 from Node 1
    type: invite_identity
    node: kv-icp-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key_3}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation_3: invitation

  - name: Join Context from Node 3
    type: join_context
    node: kv-icp-3
    context_id: "{{context_id}}"
    invitee_id: "{{public_key_3}}"
    invitation: "{{invitation_3}}"

  - name: Wait for Consensus After Join
    type: wait
    seconds: 2

  # ============================================
  # Testing Phase: Test KV operations
  # ============================================
  - name: Set Key-Value Pair from Node 1
    type: call
    node: kv-icp-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: set
    args:
      key: "test_key"
      value: "test_value"

  - name: Wait for Set Operation
    type: wait
    seconds: 2

  - name: Get Value from Node 1
    type: call
    node: kv-icp-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get
    args:
      key: "test_key"
    outputs:
      get_result: result

  - name: Assert Get Result on Node 1
    type: json_assert
    statements:
      - 'json_equal({{get_result}}, {"output": "test_value"})'

  - name: Get Value from Node 2 (verify sync)
    type: call
    node: kv-icp-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_2}}"
    method: get
    args:
      key: "test_key"
    outputs:
      get_result_2: result

  - name: Assert Value Synced to Node 2
    type: json_assert
    statements:
      - 'json_equal({{get_result_2}}, {"output": "test_value"})'

  - name: Update Value from Node 2
    type: call
    node: kv-icp-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_2}}"
    method: set
    args:
      key: "test_key"
      value: "updated_value"

  - name: Wait for Update Broadcast
    type: wait
    seconds: 2

  - name: Verify Updated Value on Node 1
    type: call
    node: kv-icp-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get
    args:
      key: "test_key"
    outputs:
      final_result: result

  - name: Assert Updated Value Propagated
    type: json_assert
    statements:
      - 'json_equal({{final_result}}, {"output": "updated_value"})'

# Configuration options
no_docker: true
stop_all_nodes: true
restart: false
wait_timeout: 30