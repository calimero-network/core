name: "Nested CRDT - NEAR"
description: "Test nested CRDT functionality on NEAR protocol"

# Test configuration
no_docker: true
force_pull_image: false

nodes:
  chain_id: calimero-testnet
  count: 3
  image: ghcr.io/calimero-network/merod:edge
  prefix: nested-near

steps:
  # ============================================
  # Setup Phase: Install app and create context
  # ============================================
  - name: Install Nested CRDT Application on Node 1
    type: install_application
    node: nested-near-1
    path: "apps/nested-crdt-test/res/nested_crdt_test.wasm"
    dev: true
    outputs:
      app_id: applicationId

  - name: Create Context on Node 1
    type: create_context
    node: nested-near-1
    application_id: "{{app_id}}"
    protocol: near
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  - name: Assert context created
    type: assert
    statements:
      - "is_set({{context_id}})"
      - "is_set({{member_public_key}})"

  # ============================================
  # Identity Phase: Create identities
  # ============================================
  - name: Create Identity on Node 2
    type: create_identity
    node: nested-near-2
    outputs:
      public_key_2: publicKey

  - name: Create Identity on Node 3
    type: create_identity
    node: nested-near-3
    outputs:
      public_key_3: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 3

  # ============================================
  # Invitation Phase: Invite and join
  # ============================================
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: nested-near-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key_2}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation_2: invitation

  - name: Join Context from Node 2
    type: join_context
    node: nested-near-2
    context_id: "{{context_id}}"
    invitee_id: "{{public_key_2}}"
    invitation: "{{invitation_2}}"

  - name: Invite Node 3 from Node 1
    type: invite_identity
    node: nested-near-1
    context_id: "{{context_id}}"
    grantee_id: "{{public_key_3}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation_3: invitation

  - name: Join Context from Node 3
    type: join_context
    node: nested-near-3
    context_id: "{{context_id}}"
    invitee_id: "{{public_key_3}}"
    invitation: "{{invitation_3}}"

  - name: Wait for Consensus After Join
    type: wait
    seconds: 3

  # ============================================
  # Testing Phase: Nested CRDT operations
  # ============================================
  - name: Initialize Nested Structure from Node 1
    type: call
    node: nested-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: init_nested_structure

  - name: Wait for initialization
    type: wait
    seconds: 2

  - name: Add Item from Node 2
    type: call
    node: nested-near-2
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_2}}"
    method: add_item
    args:
      key: "item1"
      value: "value1"

  - name: Add Item from Node 3
    type: call
    node: nested-near-3
    context_id: "{{context_id}}"
    executor_public_key: "{{public_key_3}}"
    method: add_item
    args:
      key: "item2"
      value: "value2"

  - name: Wait for CRDT synchronization
    type: wait
    seconds: 3

  - name: Get All Items from Node 1
    type: call
    node: nested-near-1
    context_id: "{{context_id}}"
    executor_public_key: "{{member_public_key}}"
    method: get_all_items
    outputs:
      all_items: result

  - name: Assert items synchronized
    type: assert
    statements:
      - "is_set({{all_items}})"

# Configuration options
no_docker: true
stop_all_nodes: true
restart: false
wait_timeout: 90