description: KV-Store Frozen storage workflow test
name: KV-store frozen storage workflow

# Configuration options
stop_all_nodes: false
restart: false  
wait_timeout: 120

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: new-calimero-node

steps:
  # Step 1: Install the application on the first node
  - name: Install Application on Node 1
    type: install_application
    node: new-calimero-node-1
    path: "./res/kv_store_with_user_and_frozen_storage.wasm"
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create mesh with both nodes
  - name: Create Mesh
    type: create_mesh
    context_node: new-calimero-node-1
    application_id: '{{app_id}}'
    nodes:
      - new-calimero-node-2
    capability: member
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # ============================================
  # Testing Phase: Frozen Storage
  # ============================================

  # Step 6: Set a value in the storage
  - name: Set value in the storage 'my_key1':'my_value1'
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set
    args:
      key: "my_key1"
      value: "my_value1"

  # Step 7: frozen storage set
  - name: Frozen storage set test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: add_frozen
    args:
      value: "SomeFrozenString"
    outputs:
      frozen_value_hash_hex: result.output

  - name: Assert frozen storage key is expected
    type: json_assert
    statements:
      - 'json_equal({{frozen_value_hash_hex}}, "c8acd3c44a96324de12a82dd674aa1c93a635fbb76a852ae14363f9b1971beb1")'

  # Step 8: frozen storage get
  - name: Frozen storage get test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_frozen
    args:
      hash_hex: "{{frozen_value_hash_hex}}"
    outputs:
      frozen_value_res: result

  - name: Assert frozen value got is expected
    type: json_assert
    statements:
      - 'json_equal({{frozen_value_res}}, {"output": "SomeFrozenString"})'

  # Wait after Node 1 messages
  - name: Wait after Node 1 Messages
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - new-calimero-node-1
      - new-calimero-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 11: Node2: get frozen storage
  - name: Node 2 - frozen storage get test
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_new-calimero-node-2}}'
    method: get_frozen
    args:
      hash_hex: "{{frozen_value_hash_hex}}"
    outputs:
      node2_frozen_value_res: result

  - name: Node 2 - Assert frozen storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{node2_frozen_value_res}}, {"output": "SomeFrozenString"})'

  # Step 12: Node2: set frozen storage
  - name: Frozen storage set test (on Node 2)
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_new-calimero-node-2}}'
    method: add_frozen
    args:
      value: "SomeFrozenString2"
    outputs:
      frozen_value_hash_hex_node2: result.output

  - name: Node 2 - Assert frozen storage key is expected
    type: json_assert
    statements:
      - 'json_equal({{frozen_value_hash_hex_node2}}, "ceaa4337dea4ad0ced60eb2c58a7b69ecab93fe07ee76e0ad2fd5dcb4001f5ff")'

  # Wait after Node 2 messages
  - name: Wait after Node 2 Messages
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - new-calimero-node-1
      - new-calimero-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Step 13: Node1: get frozen storage (that was set by Node2)
  - name: Node 1 - frozen storage get test (that was set by Node2)
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_frozen
    args:
      hash_hex: "{{frozen_value_hash_hex_node2}}"
    outputs:
      node1_frozen_value_from_node2_res: result

  - name: Node 1 - Assert frozen storage value got (from Node 2) is expected
    type: json_assert
    statements:
      - 'json_equal({{node1_frozen_value_from_node2_res}}, {"output": "SomeFrozenString2"})'

  # ============================================
  # FrozenStorage Intrinsics Tests
  # ============================================
  
  # Test: Content-addressability - same content = same hash (idempotent)
  - name: Node 1 inserts same content again (idempotent test)
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: add_frozen
    args:
      value: "SomeFrozenString"
    outputs:
      frozen_hash_idempotent: result.output

  - name: Assert idempotent insert returns same hash
    type: json_assert
    statements:
      - 'json_equal({{frozen_hash_idempotent}}, "{{frozen_value_hash_hex}}")'

  # Test: Content-addressability - different content = different hash
  - name: Node 2 inserts different content
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_new-calimero-node-2}}'
    method: add_frozen
    args:
      value: "DifferentFrozenContent"
    outputs:
      frozen_hash_different: result.output

  - name: Wait for frozen storage sync
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - new-calimero-node-1
      - new-calimero-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  # Test: Merge behavior - FrozenValue::merge() does nothing (immutable)
  # Both nodes should have both entries after merge
  - name: Node 1 verifies both frozen entries exist after merge
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_frozen
    args:
      hash_hex: "{{frozen_value_hash_hex}}"
    outputs:
      node1_original: result

  - name: Node 1 verifies different content entry exists
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_frozen
    args:
      hash_hex: "{{frozen_hash_different}}"
    outputs:
      node1_different: result

  - name: Assert frozen storage merge preserves all entries
    type: json_assert
    statements:
      - 'json_equal({{node1_original}}, {"output": "SomeFrozenString"})'
      - 'json_equal({{node1_different}}, {"output": "DifferentFrozenContent"})'

  # Test: Concurrent inserts of same content from different nodes
  # Should result in same hash (content-addressable) and merge correctly
  - name: Node 1 inserts content for concurrent test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: add_frozen
    args:
      value: "ConcurrentContent"
    outputs:
      concurrent_hash_1: result.output

  - name: Node 2 inserts same content concurrently
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_new-calimero-node-2}}'
    method: add_frozen
    args:
      value: "ConcurrentContent"
    outputs:
      concurrent_hash_2: result.output

  - name: Wait for concurrent frozen storage merge
    type: wait_for_sync
    context_id: "{{context_id}}"
    nodes:
      - new-calimero-node-1
      - new-calimero-node-2
    timeout: 60
    check_interval: 2
    trigger_sync: true

  - name: Assert concurrent inserts produce same hash (content-addressable)
    type: json_assert
    statements:
      - 'json_equal({{concurrent_hash_1}}, {{concurrent_hash_2}})'

  - name: Verify both nodes can retrieve concurrent content
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{public_key_new-calimero-node-2}}'
    method: get_frozen
    args:
      hash_hex: "{{concurrent_hash_1}}"
    outputs:
      concurrent_retrieved: result

  - name: Assert concurrent content retrieved correctly
    type: json_assert
    statements:
      - 'json_equal({{concurrent_retrieved}}, {"output": "ConcurrentContent"})'
