description: KV-Store user storage workflow test
name: KV-store user storage workflow

# Configuration options
stop_all_nodes: true
restart: true
wait_timeout: 120

nodes:
  chain_id: testnet-1
  count: 2
  image: ghcr.io/calimero-network/merod:edge
  prefix: new-calimero-node

steps:
  # Step 1: Install the application on the first node
  - name: Install Application on Node 1
    type: install_application
    node: new-calimero-node-1
    path: "./res/kv_store_with_user_and_frozen_storage.wasm"
    dev: true
    outputs:
      app_id: applicationId

  # Step 2: Create a context using the installed application
  - name: Create Context on Node 1
    type: create_context
    node: new-calimero-node-1
    application_id: '{{app_id}}'
    params: '{}'
    outputs:
      context_id: contextId
      member_public_key: memberPublicKey

  # Step 3: Generate identity on second node
  - name: Create Identity on Node 2
    type: create_identity
    node: new-calimero-node-2
    outputs:
      node2_public_key: publicKey

  - name: Wait for Identity Creation
    type: wait
    seconds: 5

  # Step 4: Invite second node to join the context
  - name: Invite Node 2 from Node 1
    type: invite_identity
    node: new-calimero-node-1
    context_id: "{{context_id}}"
    grantee_id: "{{node2_public_key}}"
    granter_id: "{{member_public_key}}"
    capability: member
    outputs:
      invitation: invitation

  # Step 5: Join context from second node
  - name: Join Context from Node 2
    type: join_context
    node: new-calimero-node-2
    context_id: "{{context_id}}"
    invitee_id: "{{node2_public_key}}"
    invitation: "{{invitation}}"

  # ============================================
  # Testing Phase: User Storage Simple
  # ============================================

  # Step 7: simple user storage set
  - name: Simple user storage set test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set_user_simple
    args:
      value: "SomeSimpleUserString"

  # Step 8: simple user storage get
  - name: Simple user storage get test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_simple
    outputs:
      simple_value_res: result

  - name: Assert simple user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{simple_value_res}}, {"output": "SomeSimpleUserString"})'

  # Step 9: nested user storage set
  - name: Nested user storage set test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: set_user_nested
    args:
      key: "UserNestedKey1"
      value: "UserNestedValue1"

  - name: Nested user storage get test
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_nested
    args:
      key: "UserNestedKey1"
    outputs:
      nested_value_res: result

  - name: Assert nested user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{nested_value_res}}, {"output": "UserNestedValue1"})'

  # Step 10: get simple user storage on Node 1
  - name: Simple user storage get test for a specific user
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_simple
    outputs:
      simple_value_res_specific_user: result

  - name: Assert simple user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{simple_value_res_specific_user}}, {"output": "SomeSimpleUserString"})'

  # Wait after Node 1 messages
  - name: Wait after Node 1 Messages
    type: wait
    seconds: 15

  # Step 11: Node2: get simple user storage for a specific user
  - name: Node 2 - Simple user storage get test for a specific user
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node2_public_key}}'
    method: get_user_simple_for
    args:
      user_key: "{{member_public_key}}"
    outputs:
      node2_simple_value_res_specific_user: result

  - name: Assert simple user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{node2_simple_value_res_specific_user}}, {"output": "SomeSimpleUserString"})'

  # Step 12: Node2: set simple user storage
  - name: Node 2 - Simple user storage get test for a specific user
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node2_public_key}}'
    method: set_user_simple
    args:
      value: "SimpleUserStringFromNode2"

  # Step 13: Node2: get simple user storage (belongs to Node2 PublicKey)
  - name: Simple user storage get test for a specific user
    type: call
    node: new-calimero-node-2
    context_id: '{{context_id}}'
    executor_public_key: '{{node2_public_key}}'
    method: get_user_simple
    outputs:
      node2_simple_value_res: result

  - name: Assert simple user storage on Node 2 value got is expected
    type: json_assert
    statements:
      - 'json_equal({{node2_simple_value_res}}, {"output": "SimpleUserStringFromNode2"})'

  # Wait after Node 2 messages
  - name: Wait after Node 2 Messages
    type: wait
    seconds: 15

  # Step 14: Node1: get simple user storage for Node 2 user
  - name: Node 1 - Simple user storage get test for a specific user (from Node2)
    type: call
    node: new-calimero-node-1
    context_id: '{{context_id}}'
    executor_public_key: '{{member_public_key}}'
    method: get_user_simple_for
    args:
      user_key: "{{node2_public_key}}"
    outputs:
      node1_simple_value_res_from_node2: result

  - name: Assert simple user storage value got is expected
    type: json_assert
    statements:
      - 'json_equal({{node1_simple_value_res_from_node2}}, {"output": "SimpleUserStringFromNode2"})'
